OpenLayers.Layer.WMTS=OpenLayers.Class(OpenLayers.Layer.Grid,{isBaseLayer:true,version:"1.0.0",requestEncoding:"KVP",url:null,layer:null,matrixSet:null,style:null,format:"image/jpeg",tileOrigin:null,tileFullExtent:null,formatSuffix:null,matrixIds:null,dimensions:null,params:null,zoomOffset:0,serverResolutions:null,formatSuffixMap:{"image/png":"png","image/png8":"png","image/png24":"png","image/png32":"png",png:"png","image/jpeg":"jpg","image/jpg":"jpg",jpeg:"jpg",jpg:"jpg"},matrix:null,initialize:function(c){var f={url:true,layer:true,style:true,matrixSet:true};for(var g in f){if(!(g in c)){throw new Error("Missing property '"+g+"' in layer configuration.")}}c.params=OpenLayers.Util.upperCaseObject(c.params);var b=[c.name,c.url,c.params,c];OpenLayers.Layer.Grid.prototype.initialize.apply(this,b);if(!this.formatSuffix){this.formatSuffix=this.formatSuffixMap[this.format]||this.format.split("/").pop()}if(this.matrixIds){var a=this.matrixIds.length;if(a&&typeof this.matrixIds[0]==="string"){var e=this.matrixIds;this.matrixIds=new Array(a);for(var d=0;d<a;++d){this.matrixIds[d]={identifier:e[d]}}}}},setMap:function(){OpenLayers.Layer.Grid.prototype.setMap.apply(this,arguments)},updateMatrixProperties:function(){this.matrix=this.getMatrix();if(this.matrix){if(this.matrix.topLeftCorner){this.tileOrigin=this.matrix.topLeftCorner}if(this.matrix.tileWidth&&this.matrix.tileHeight){this.tileSize=new OpenLayers.Size(this.matrix.tileWidth,this.matrix.tileHeight)}if(!this.tileOrigin){this.tileOrigin=new OpenLayers.LonLat(this.maxExtent.left,this.maxExtent.top)}if(!this.tileFullExtent){this.tileFullExtent=this.maxExtent}}},moveTo:function(b,a,c){if(a||!this.matrix){this.updateMatrixProperties()}return OpenLayers.Layer.Grid.prototype.moveTo.apply(this,arguments)},clone:function(a){if(a==null){a=new OpenLayers.Layer.WMTS(this.options)}a=OpenLayers.Layer.Grid.prototype.clone.apply(this,[a]);return a},getIdentifier:function(){return this.getServerZoom()},getMatrix:function(){var b;if(!this.matrixIds||this.matrixIds.length===0){b={identifier:this.getIdentifier()}}else{if("scaleDenominator" in this.matrixIds[0]){var a=OpenLayers.METERS_PER_INCH*OpenLayers.INCHES_PER_UNIT[this.units]*this.getServerResolution()/0.00028;var e=Number.POSITIVE_INFINITY;var f;for(var c=0,d=this.matrixIds.length;c<d;++c){f=Math.abs(1-(this.matrixIds[c].scaleDenominator/a));if(f<e){e=f;b=this.matrixIds[c]}}}else{b=this.matrixIds[this.getIdentifier()]}}return b},getTileInfo:function(f){var b=this.getServerResolution();var d=(f.lon-this.tileOrigin.lon)/(b*this.tileSize.w);var c=(this.tileOrigin.lat-f.lat)/(b*this.tileSize.h);var a=Math.floor(d);var e=Math.floor(c);return{col:a,row:e,i:Math.floor((d-a)*this.tileSize.w),j:Math.floor((c-e)*this.tileSize.h)}},getURL:function(a){a=this.adjustBounds(a);var d="";if(!this.tileFullExtent||this.tileFullExtent.intersectsBounds(a)){var c=a.getCenterLonLat();var f=this.getTileInfo(c);var k=this.matrix.identifier;var b=this.dimensions,g;if(OpenLayers.Util.isArray(this.url)){d=this.selectUrl([this.version,this.style,this.matrixSet,this.matrix.identifier,f.row,f.col].join(","),this.url)}else{d=this.url}if(this.requestEncoding.toUpperCase()==="REST"){g=this.params;if(d.indexOf("{")!==-1){var l=d.replace(/\{/g,"${");var e={style:this.style,Style:this.style,TileMatrixSet:this.matrixSet,TileMatrix:this.matrix.identifier,TileRow:f.row,TileCol:f.col};if(b){var h,j;for(j=b.length-1;j>=0;--j){h=b[j];e[h]=g[h.toUpperCase()]}}d=OpenLayers.String.format(l,e)}else{var m=this.version+"/"+this.layer+"/"+this.style+"/";if(b){for(var j=0;j<b.length;j++){if(g[b[j]]){m=m+g[b[j]]+"/"}}}m=m+this.matrixSet+"/"+this.matrix.identifier+"/"+f.row+"/"+f.col+"."+this.formatSuffix;if(!d.match(/\/$/)){d=d+"/"}d=d+m}}else{if(this.requestEncoding.toUpperCase()==="KVP"){g={SERVICE:"WMTS",REQUEST:"GetTile",VERSION:this.version,LAYER:this.layer,STYLE:this.style,TILEMATRIXSET:this.matrixSet,TILEMATRIX:this.matrix.identifier,TILEROW:f.row,TILECOL:f.col,FORMAT:this.format};d=OpenLayers.Layer.Grid.prototype.getFullRequestString.apply(this,[g])}}}return d},mergeNewParams:function(a){if(this.requestEncoding.toUpperCase()==="KVP"){return OpenLayers.Layer.Grid.prototype.mergeNewParams.apply(this,[OpenLayers.Util.upperCaseObject(a)])}},CLASS_NAME:"OpenLayers.Layer.WMTS"});