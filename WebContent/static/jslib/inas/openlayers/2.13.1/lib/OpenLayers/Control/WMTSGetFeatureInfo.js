OpenLayers.Control.WMTSGetFeatureInfo=OpenLayers.Class(OpenLayers.Control,{hover:false,requestEncoding:"KVP",drillDown:false,maxFeatures:10,clickCallback:"click",layers:null,queryVisible:true,infoFormat:"text/html",vendorParams:{},format:null,formatOptions:null,handler:null,hoverRequest:null,pending:0,initialize:function(a){a=a||{};a.handlerOptions=a.handlerOptions||{};OpenLayers.Control.prototype.initialize.apply(this,[a]);if(!this.format){this.format=new OpenLayers.Format.WMSGetFeatureInfo(a.formatOptions)}if(this.drillDown===true){this.hover=false}if(this.hover){this.handler=new OpenLayers.Handler.Hover(this,{move:this.cancelHover,pause:this.getInfoForHover},OpenLayers.Util.extend(this.handlerOptions.hover||{},{delay:250}))}else{var b={};b[this.clickCallback]=this.getInfoForClick;this.handler=new OpenLayers.Handler.Click(this,b,this.handlerOptions.click||{})}},getInfoForClick:function(a){this.request(a.xy,{})},getInfoForHover:function(a){this.request(a.xy,{hover:true})},cancelHover:function(){if(this.hoverRequest){--this.pending;if(this.pending<=0){OpenLayers.Element.removeClass(this.map.viewPortDiv,"olCursorWait");this.pending=0}this.hoverRequest.abort();this.hoverRequest=null}},findLayers:function(){var c=this.layers||this.map.layers;var d=[];var b;for(var a=c.length-1;a>=0;--a){b=c[a];if(b instanceof OpenLayers.Layer.WMTS&&b.requestEncoding===this.requestEncoding&&(!this.queryVisible||b.getVisibility())){d.push(b);if(!this.drillDown||this.hover){break}}}return d},buildRequestOptions:function(b,c){var f=this.map.getLonLatFromPixel(c);var e=b.getURL(new OpenLayers.Bounds(f.lon,f.lat,f.lon,f.lat));var d=OpenLayers.Util.getParameters(e);var a=b.getTileInfo(f);OpenLayers.Util.extend(d,{service:"WMTS",version:b.version,request:"GetFeatureInfo",infoFormat:this.infoFormat,i:a.i,j:a.j});OpenLayers.Util.applyDefaults(d,this.vendorParams);return{url:OpenLayers.Util.isArray(b.url)?b.url[0]:b.url,params:OpenLayers.Util.upperCaseObject(d),callback:function(g){this.handleResponse(c,g,b)},scope:this}},request:function(h,j){j=j||{};var c=this.findLayers();if(c.length>0){var g,e;for(var d=0,f=c.length;d<f;d++){e=c[d];g=this.events.triggerEvent("beforegetfeatureinfo",{xy:h,layer:e});if(g!==false){++this.pending;var a=this.buildRequestOptions(e,h);var b=OpenLayers.Request.GET(a);if(j.hover===true){this.hoverRequest=b}}}if(this.pending>0){OpenLayers.Element.addClass(this.map.viewPortDiv,"olCursorWait")}}},handleResponse:function(g,e,b){--this.pending;if(this.pending<=0){OpenLayers.Element.removeClass(this.map.viewPortDiv,"olCursorWait");this.pending=0}if(e.status&&(e.status<200||e.status>=300)){this.events.triggerEvent("exception",{xy:g,request:e,layer:b})}else{var f=e.responseXML;if(!f||!f.documentElement){f=e.responseText}var d,c;try{d=this.format.read(f)}catch(a){c=true;this.events.triggerEvent("exception",{xy:g,request:e,error:a,layer:b})}if(!c){this.events.triggerEvent("getfeatureinfo",{text:e.responseText,features:d,request:e,xy:g,layer:b})}}},CLASS_NAME:"OpenLayers.Control.WMTSGetFeatureInfo"});