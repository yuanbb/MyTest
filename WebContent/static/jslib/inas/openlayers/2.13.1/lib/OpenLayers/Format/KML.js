OpenLayers.Format.KML=OpenLayers.Class(OpenLayers.Format.XML,{namespaces:{kml:"http://www.opengis.net/kml/2.2",gx:"http://www.google.com/kml/ext/2.2"},kmlns:"http://earth.google.com/kml/2.0",placemarksDesc:"No description available",foldersName:"OpenLayers export",foldersDesc:"Exported on "+new Date(),extractAttributes:true,kvpAttributes:false,extractStyles:false,extractTracks:false,trackAttributes:null,internalns:null,features:null,styles:null,styleBaseUrl:"",fetched:null,maxDepth:0,initialize:function(a){this.regExes={trimSpace:(/^\s*|\s*$/g),removeSpace:(/\s*/g),splitSpace:(/\s+/),trimComma:(/\s*,\s*/g),kmlColor:(/(\w{2})(\w{2})(\w{2})(\w{2})/),kmlIconPalette:(/root:\/\/icons\/palette-(\d+)(\.\w+)/),straightBracket:(/\$\[(.*?)\]/g)};this.externalProjection=new OpenLayers.Projection("EPSG:4326");OpenLayers.Format.XML.prototype.initialize.apply(this,[a])},read:function(b){this.features=[];this.styles={};this.fetched={};var a={depth:0,styleBaseUrl:this.styleBaseUrl};return this.parseData(b,a)},parseData:function(g,c){if(typeof g=="string"){g=OpenLayers.Format.XML.prototype.read.apply(this,[g])}var e=["Link","NetworkLink","Style","StyleMap","Placemark"];for(var d=0,a=e.length;d<a;++d){var f=e[d];var b=this.getElementsByTagNameNS(g,"*",f);if(b.length==0){continue}switch(f.toLowerCase()){case"link":case"networklink":this.parseLinks(b,c);break;case"style":if(this.extractStyles){this.parseStyles(b,c)}break;case"stylemap":if(this.extractStyles){this.parseStyleMaps(b,c)}break;case"placemark":this.parseFeatures(b,c);break}}return this.features},parseLinks:function(c,d){if(d.depth>=this.maxDepth){return false}var g=OpenLayers.Util.extend({},d);g.depth++;for(var e=0,a=c.length;e<a;e++){var b=this.parseProperty(c[e],"*","href");if(b&&!this.fetched[b]){this.fetched[b]=true;var f=this.fetchLink(b);if(f){this.parseData(f,g)}}}},fetchLink:function(a){var b=OpenLayers.Request.GET({url:a,async:false});if(b){return b.responseText}},parseStyles:function(b,c){for(var e=0,a=b.length;e<a;e++){var f=this.parseStyle(b[e]);if(f){var d=(c.styleBaseUrl||"")+"#"+f.id;this.styles[d]=f}}},parseKmlColor:function(b){var a=null;if(b){var c=b.match(this.regExes.kmlColor);if(c){a={color:"#"+c[4]+c[3]+c[2],opacity:parseInt(c[1],16)/255}}}return a},parseStyle:function(A){var I={};var r=["LineStyle","PolyStyle","IconStyle","BalloonStyle","LabelStyle"];var e,l,L,g,d;for(var F=0,H=r.length;F<H;++F){e=r[F];l=this.getElementsByTagNameNS(A,"*",e)[0];if(!l){continue}switch(e.toLowerCase()){case"linestyle":var c=this.parseProperty(l,"*","color");var C=this.parseKmlColor(c);if(C){I.strokeColor=C.color;I.strokeOpacity=C.opacity}var z=this.parseProperty(l,"*","width");if(z){I.strokeWidth=z}break;case"polystyle":var c=this.parseProperty(l,"*","color");var C=this.parseKmlColor(c);if(C){I.fillOpacity=C.opacity;I.fillColor=C.color}var D=this.parseProperty(l,"*","fill");if(D=="0"){I.fillColor="none"}var j=this.parseProperty(l,"*","outline");if(j=="0"){I.strokeWidth="0"}break;case"iconstyle":var N=parseFloat(this.parseProperty(l,"*","scale")||1);var z=32*N;var u=32*N;var M=this.getElementsByTagNameNS(l,"*","Icon")[0];if(M){var E=this.parseProperty(M,"*","href");if(E){var q=this.parseProperty(M,"*","w");var G=this.parseProperty(M,"*","h");var f="http://maps.google.com/mapfiles/kml";if(OpenLayers.String.startsWith(E,f)&&!q&&!G){q=64;G=64;N=N/2}q=q||G;G=G||q;if(q){z=parseInt(q)*N}if(G){u=parseInt(G)*N}var b=E.match(this.regExes.kmlIconPalette);if(b){var J=b[1];var t=b[2];var p=this.parseProperty(M,"*","x");var o=this.parseProperty(M,"*","y");var n=p?p/32:0;var m=o?(7-o/32):7;var k=m*8+n;E="http://maps.google.com/mapfiles/kml/pal"+J+"/icon"+k+t}I.graphicOpacity=1;I.externalGraphic=E}}var s=this.getElementsByTagNameNS(l,"*","hotSpot")[0];if(s){var p=parseFloat(s.getAttribute("x"));var o=parseFloat(s.getAttribute("y"));var B=s.getAttribute("xunits");if(B=="pixels"){I.graphicXOffset=-p*N}else{if(B=="insetPixels"){I.graphicXOffset=-z+(p*N)}else{if(B=="fraction"){I.graphicXOffset=-z*p}}}var K=s.getAttribute("yunits");if(K=="pixels"){I.graphicYOffset=-u+(o*N)+1}else{if(K=="insetPixels"){I.graphicYOffset=-(o*N)+1}else{if(K=="fraction"){I.graphicYOffset=-u*(1-o)+1}}}}I.graphicWidth=z;I.graphicHeight=u;break;case"balloonstyle":var a=OpenLayers.Util.getXmlNodeValue(l);if(a){I.balloonStyle=a.replace(this.regExes.straightBracket,"${$1}")}break;case"labelstyle":var c=this.parseProperty(l,"*","color");var C=this.parseKmlColor(c);if(C){I.fontColor=C.color;I.fontOpacity=C.opacity}break;default:}}if(!I.strokeColor&&I.fillColor){I.strokeColor=I.fillColor}var v=A.getAttribute("id");if(v&&I){I.id=v}return I},parseStyleMaps:function(a,n){for(var g=0,h=a.length;g<h;g++){var d=a[g];var c=this.getElementsByTagNameNS(d,"*","Pair");var b=d.getAttribute("id");for(var f=0,m=c.length;f<m;f++){var e=c[f];var l=this.parseProperty(e,"*","key");var k=this.parseProperty(e,"*","styleUrl");if(k&&l=="normal"){this.styles[(n.styleBaseUrl||"")+"#"+b]=this.styles[(n.styleBaseUrl||"")+k]}}}},parseFeatures:function(b,m){var f=[];for(var g=0,h=b.length;g<h;g++){var c=b[g];var l=this.parseFeature.apply(this,[c]);if(l){if(this.extractStyles&&l.attributes&&l.attributes.styleUrl){l.style=this.getStyle(l.attributes.styleUrl,m)}if(this.extractStyles){var k=this.getElementsByTagNameNS(c,"*","Style")[0];if(k){var e=this.parseStyle(k);if(e){l.style=OpenLayers.Util.extend(l.style,e)}}}if(this.extractTracks){var j=this.getElementsByTagNameNS(c,this.namespaces.gx,"Track");if(j&&j.length>0){var d=j[0];var a={features:[],feature:l};this.readNode(d,a);if(a.features.length>0){f.push.apply(f,a.features)}}}else{f.push(l)}}else{throw"Bad Placemark: "+g}}this.features=this.features.concat(f)},readers:{kml:{when:function(b,a){a.whens.push(OpenLayers.Date.parse(this.getChildValue(b)))},_trackPointAttribute:function(c,a){var b=c.nodeName.split(":").pop();a.attributes[b].push(this.getChildValue(c))}},gx:{Track:function(c,b){var e={whens:[],points:[],angles:[]};if(this.trackAttributes){var a;e.attributes={};for(var f=0,m=this.trackAttributes.length;f<m;++f){a=this.trackAttributes[f];e.attributes[a]=[];if(!(a in this.readers.kml)){this.readers.kml[a]=this.readers.kml._trackPointAttribute}}}this.readChildNodes(c,e);if(e.whens.length!==e.points.length){throw new Error("gx:Track with unequal number of when ("+e.whens.length+") and gx:coord ("+e.points.length+") elements.")}var k=e.angles.length>0;if(k&&e.whens.length!==e.angles.length){throw new Error("gx:Track with unequal number of when ("+e.whens.length+") and gx:angles ("+e.angles.length+") elements.")}var n,l,h;for(var f=0,m=e.whens.length;f<m;++f){n=b.feature.clone();n.fid=b.feature.fid||b.feature.id;l=e.points[f];n.geometry=l;if("z" in l){n.attributes.altitude=l.z}if(this.internalProjection&&this.externalProjection){n.geometry.transform(this.externalProjection,this.internalProjection)}if(this.trackAttributes){for(var d=0,g=this.trackAttributes.length;d<g;++d){var a=this.trackAttributes[d];n.attributes[a]=e.attributes[a][f]}}n.attributes.when=e.whens[f];n.attributes.trackId=b.feature.id;if(k){h=e.angles[f];n.attributes.heading=parseFloat(h[0]);n.attributes.tilt=parseFloat(h[1]);n.attributes.roll=parseFloat(h[2])}b.features.push(n)}},coord:function(c,b){var e=this.getChildValue(c);var d=e.replace(this.regExes.trimSpace,"").split(/\s+/);var a=new OpenLayers.Geometry.Point(d[0],d[1]);if(d.length>2){a.z=parseFloat(d[2])}b.points.push(a)},angles:function(b,a){var d=this.getChildValue(b);var c=d.replace(this.regExes.trimSpace,"").split(/\s+/);a.angles.push(c)}}},parseFeature:function(b){var c=["MultiGeometry","Polygon","LineString","Point"];var j,e,k,a;for(var g=0,h=c.length;g<h;++g){j=c[g];this.internalns=b.namespaceURI?b.namespaceURI:this.kmlns;e=this.getElementsByTagNameNS(b,this.internalns,j);if(e.length>0){var a=this.parseGeometry[j.toLowerCase()];if(a){k=a.apply(this,[e[0]]);if(this.internalProjection&&this.externalProjection){k.transform(this.externalProjection,this.internalProjection)}}else{throw new TypeError("Unsupported geometry type: "+j)}break}}var f;if(this.extractAttributes){f=this.parseAttributes(b)}var l=new OpenLayers.Feature.Vector(k,f);var d=b.getAttribute("id")||b.getAttribute("name");if(d!=null){l.fid=d}return l},getStyle:function(b,a){var c=OpenLayers.Util.removeTail(b);var f=OpenLayers.Util.extend({},a);f.depth++;f.styleBaseUrl=c;if(!this.styles[b]&&!OpenLayers.String.startsWith(b,"#")&&f.depth<=this.maxDepth&&!this.fetched[c]){var e=this.fetchLink(c);if(e){this.parseData(e,f)}}var d=OpenLayers.Util.extend({},this.styles[b]);return d},parseGeometry:{point:function(d){var c=this.getElementsByTagNameNS(d,this.internalns,"coordinates");var e=[];if(c.length>0){var b=c[0].firstChild.nodeValue;b=b.replace(this.regExes.removeSpace,"");e=b.split(",")}var a=null;if(e.length>1){if(e.length==2){e[2]=null}a=new OpenLayers.Geometry.Point(e[0],e[1],e[2])}else{throw"Bad coordinate string: "+b}return a},linestring:function(c,e){var d=this.getElementsByTagNameNS(c,this.internalns,"coordinates");var l=null;if(d.length>0){var b=this.getChildValue(d[0]);b=b.replace(this.regExes.trimSpace,"");b=b.replace(this.regExes.trimComma,",");var a=b.split(this.regExes.splitSpace);var h=a.length;var k=new Array(h);var j,g;for(var f=0;f<h;++f){j=a[f].split(",");g=j.length;if(g>1){if(j.length==2){j[2]=null}k[f]=new OpenLayers.Geometry.Point(j[0],j[1],j[2])}else{throw"Bad LineString point coordinates: "+a[f]}}if(h){if(e){l=new OpenLayers.Geometry.LinearRing(k)}else{l=new OpenLayers.Geometry.LineString(k)}}else{throw"Bad LineString coordinates: "+b}}return l},polygon:function(f){var c=this.getElementsByTagNameNS(f,this.internalns,"LinearRing");var g=c.length;var e=new Array(g);if(g>0){var b;for(var d=0,a=c.length;d<a;++d){b=this.parseGeometry.linestring.apply(this,[c[d],true]);if(b){e[d]=b}else{throw"Bad LinearRing geometry: "+d}}}return new OpenLayers.Geometry.Polygon(e)},multigeometry:function(e){var h,g;var f=[];var c=e.childNodes;for(var b=0,a=c.length;b<a;++b){h=c[b];if(h.nodeType==1){var d=(h.prefix)?h.nodeName.split(":")[1]:h.nodeName;var g=this.parseGeometry[d.toLowerCase()];if(g){f.push(g.apply(this,[h]))}}}return new OpenLayers.Geometry.Collection(f)}},parseAttributes:function(d){var f={};var h=d.getElementsByTagName("ExtendedData");if(h.length){f=this.parseExtendedData(h[0])}var b,n,m;var c=d.childNodes;for(var j=0,k=c.length;j<k;++j){b=c[j];if(b.nodeType==1){n=b.childNodes;if(n.length>=1&&n.length<=3){var m;switch(n.length){case 1:m=n[0];break;case 2:var g=n[0];var e=n[1];m=(g.nodeType==3||g.nodeType==4)?g:e;break;case 3:default:m=n[1];break}if(m.nodeType==3||m.nodeType==4){var a=(b.prefix)?b.nodeName.split(":")[1]:b.nodeName;var l=OpenLayers.Util.getXmlNodeValue(m);if(l){l=l.replace(this.regExes.trimSpace,"");f[a]=l}}}}}return f},parseExtendedData:function(b){var d={};var f,h,e,k;var c=b.getElementsByTagName("Data");for(f=0,h=c.length;f<h;f++){e=c[f];k=e.getAttribute("name");var g={};var l=e.getElementsByTagName("value");if(l.length){g.value=this.getChildValue(l[0])}if(this.kvpAttributes){d[k]=g.value}else{var a=e.getElementsByTagName("displayName");if(a.length){g.displayName=this.getChildValue(a[0])}d[k]=g}}var j=b.getElementsByTagName("SimpleData");for(f=0,h=j.length;f<h;f++){var g={};e=j[f];k=e.getAttribute("name");g.value=this.getChildValue(e);if(this.kvpAttributes){d[k]=g.value}else{g.displayName=k;d[k]=g}}return d},parseProperty:function(c,d,b){var f;var a=this.getElementsByTagNameNS(c,d,b);try{f=OpenLayers.Util.getXmlNodeValue(a[0])}catch(g){f=null}return f},write:function(d){if(!(OpenLayers.Util.isArray(d))){d=[d]}var b=this.createElementNS(this.kmlns,"kml");var e=this.createFolderXML();for(var c=0,a=d.length;c<a;++c){e.appendChild(this.createPlacemarkXML(d[c]))}b.appendChild(e);return OpenLayers.Format.XML.prototype.write.apply(this,[b])},createFolderXML:function(){var c=this.createElementNS(this.kmlns,"Folder");if(this.foldersName){var e=this.createElementNS(this.kmlns,"name");var d=this.createTextNode(this.foldersName);e.appendChild(d);c.appendChild(e)}if(this.foldersDesc){var a=this.createElementNS(this.kmlns,"description");var b=this.createTextNode(this.foldersDesc);a.appendChild(b);c.appendChild(a)}return c},createPlacemarkXML:function(i){var b=this.createElementNS(this.kmlns,"name");var f=(i.style&&i.style.label)?i.style.label:i.id;var a=i.attributes.name||f;b.appendChild(this.createTextNode(a));var h=this.createElementNS(this.kmlns,"description");var d=i.attributes.description||this.placemarksDesc;h.appendChild(this.createTextNode(d));var e=this.createElementNS(this.kmlns,"Placemark");if(i.fid!=null){e.setAttribute("id",i.fid)}e.appendChild(b);e.appendChild(h);var c=this.buildGeometryNode(i.geometry);e.appendChild(c);if(i.attributes){var g=this.buildExtendedData(i.attributes);if(g){e.appendChild(g)}}return e},buildGeometryNode:function(e){var c=e.CLASS_NAME;var b=c.substring(c.lastIndexOf(".")+1);var a=this.buildGeometry[b.toLowerCase()];var d=null;if(a){d=a.apply(this,[e])}return d},buildGeometry:{point:function(b){var a=this.createElementNS(this.kmlns,"Point");a.appendChild(this.buildCoordinatesNode(b));return a},multipoint:function(a){return this.buildGeometry.collection.apply(this,[a])},linestring:function(b){var a=this.createElementNS(this.kmlns,"LineString");a.appendChild(this.buildCoordinatesNode(b));return a},multilinestring:function(a){return this.buildGeometry.collection.apply(this,[a])},linearring:function(b){var a=this.createElementNS(this.kmlns,"LinearRing");a.appendChild(this.buildCoordinatesNode(b));return a},polygon:function(h){var b=this.createElementNS(this.kmlns,"Polygon");var g=h.components;var e,f,d;for(var c=0,a=g.length;c<a;++c){d=(c==0)?"outerBoundaryIs":"innerBoundaryIs";e=this.createElementNS(this.kmlns,d);f=this.buildGeometry.linearring.apply(this,[g[c]]);e.appendChild(f);b.appendChild(e)}return b},multipolygon:function(a){return this.buildGeometry.collection.apply(this,[a])},collection:function(d){var b=this.createElementNS(this.kmlns,"MultiGeometry");var e;for(var c=0,a=d.components.length;c<a;++c){e=this.buildGeometryNode.apply(this,[d.components[c]]);if(e){b.appendChild(e)}}return b}},buildCoordinatesNode:function(e){var a=this.createElementNS(this.kmlns,"coordinates");var j;var h=e.components;if(h){var g;var f=h.length;var c=new Array(f);for(var d=0;d<f;++d){g=h[d];c[d]=this.buildCoordinates(g)}j=c.join(" ")}else{j=this.buildCoordinates(e)}var b=this.createTextNode(j);a.appendChild(b);return a},buildCoordinates:function(a){if(this.internalProjection&&this.externalProjection){a=a.clone();a.transform(this.internalProjection,this.externalProjection)}return a.x+","+a.y},buildExtendedData:function(b){var d=this.createElementNS(this.kmlns,"ExtendedData");for(var c in b){if(b[c]&&c!="name"&&c!="description"&&c!="styleUrl"){var f=this.createElementNS(this.kmlns,"Data");f.setAttribute("name",c);var e=this.createElementNS(this.kmlns,"value");if(typeof b[c]=="object"){if(b[c].value){e.appendChild(this.createTextNode(b[c].value))}if(b[c].displayName){var a=this.createElementNS(this.kmlns,"displayName");a.appendChild(this.getXMLDoc().createCDATASection(b[c].displayName));f.appendChild(a)}}else{e.appendChild(this.createTextNode(b[c]))}f.appendChild(e);d.appendChild(f)}}if(this.isSimpleContent(d)){return null}else{return d}},CLASS_NAME:"OpenLayers.Format.KML"});