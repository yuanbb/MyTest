OpenLayers.WPSProcess=OpenLayers.Class({client:null,server:null,identifier:null,description:null,localWPS:"http://geoserver/wps",formats:null,chained:0,executeCallbacks:null,initialize:function(a){OpenLayers.Util.extend(this,a);this.executeCallbacks=[];this.formats={"application/wkt":new OpenLayers.Format.WKT(),"application/json":new OpenLayers.Format.GeoJSON()}},describe:function(a){a=a||{};if(!this.description){this.client.describeProcess(this.server,this.identifier,function(c){if(!this.description){this.parseDescription(c)}if(a.callback){a.callback.call(a.scope,this.description)}},this)}else{if(a.callback){var b=this.description;window.setTimeout(function(){a.callback.call(a.scope,b)},0)}}},configure:function(a){this.describe({callback:function(){var f=this.description,b=a.inputs,c,d,e;for(d=0,e=f.dataInputs.length;d<e;++d){c=f.dataInputs[d];this.setInputData(c,b[c.identifier])}if(a.callback){a.callback.call(a.scope)}},scope:this});return this},execute:function(a){this.configure({inputs:a.inputs,callback:function(){var b=this;var c=this.getOutputIndex(b.description.processOutputs,a.output);b.setResponseForm({outputIndex:c});(function d(){OpenLayers.Util.removeItem(b.executeCallbacks,d);if(b.chained!==0){b.executeCallbacks.push(d);return}OpenLayers.Request.POST({url:b.client.servers[b.server].url,data:new OpenLayers.Format.WPSExecute().write(b.description),success:function(f){var e=b.description.processOutputs[c];var i=b.findMimeType(e.complexOutput.supported.formats);var g=b.formats[i].read(f.responseText);if(g instanceof OpenLayers.Feature.Vector){g=[g]}if(a.success){var h={};h[a.output||"result"]=g;a.success.call(a.scope,h)}},scope:b})})()},scope:this})},output:function(a){return new OpenLayers.WPSProcess.ChainLink({process:this,output:a})},parseDescription:function(a){var b=this.client.servers[this.server];this.description=new OpenLayers.Format.WPSDescribeProcess().read(b.processDescription[this.identifier]).processDescriptions[this.identifier]},setInputData:function(b,c){delete b.data;delete b.reference;if(c instanceof OpenLayers.WPSProcess.ChainLink){++this.chained;b.reference={method:"POST",href:c.process.server===this.server?this.localWPS:this.client.servers[c.process.server].url};c.process.describe({callback:function(){--this.chained;this.chainProcess(b,c)},scope:this})}else{b.data={};var a=b.complexData;if(a){var d=this.findMimeType(a.supported.formats);b.data.complexData={mimeType:d,value:this.formats[d].write(this.toFeatures(c))}}else{b.data.literalData={value:c}}}},setResponseForm:function(b){b=b||{};var a=this.description.processOutputs[b.outputIndex||0];this.description.responseForm={rawDataOutput:{identifier:a.identifier,mimeType:this.findMimeType(a.complexOutput.supported.formats,b.supportedFormats)}}},getOutputIndex:function(d,b){var a;if(b){for(var c=d.length-1;c>=0;--c){if(d[c].identifier===b){a=c;break}}}else{a=0}return a},chainProcess:function(d,b){var c=this.getOutputIndex(b.process.description.processOutputs,b.output);d.reference.mimeType=this.findMimeType(d.complexData.supported.formats,b.process.description.processOutputs[c].complexOutput.supported.formats);var a={};a[d.reference.mimeType]=true;b.process.setResponseForm({outputIndex:c,supportedFormats:a});d.reference.body=b.process.description;while(this.executeCallbacks.length>0){this.executeCallbacks[0]()}},toFeatures:function(d){var a=OpenLayers.Util.isArray(d);if(!a){d=[d]}var f=new Array(d.length),e;for(var b=0,c=d.length;b<c;++b){e=d[b];f[b]=e instanceof OpenLayers.Feature.Vector?e:new OpenLayers.Feature.Vector(e)}return a?f:f[0]},findMimeType:function(c,b){b=b||this.formats;for(var a in c){if(a in b){return a}}},CLASS_NAME:"OpenLayers.WPSProcess"});OpenLayers.WPSProcess.ChainLink=OpenLayers.Class({process:null,output:null,initialize:function(a){OpenLayers.Util.extend(this,a)},CLASS_NAME:"OpenLayers.WPSProcess.ChainLink"});