OpenLayers.Renderer.VML=OpenLayers.Class(OpenLayers.Renderer.Elements,{xmlns:"urn:schemas-microsoft-com:vml",symbolCache:{},offset:null,initialize:function(b){if(!this.supported()){return}if(!document.namespaces.olv){document.namespaces.add("olv",this.xmlns);var e=document.createStyleSheet();var c=["shape","rect","oval","fill","stroke","imagedata","group","textbox"];for(var d=0,a=c.length;d<a;d++){e.addRule("olv\\:"+c[d],"behavior: url(#default#VML); position: absolute; display: inline-block;")}}OpenLayers.Renderer.Elements.prototype.initialize.apply(this,arguments)},supported:function(){return !!(document.namespaces)},setExtent:function(k,b){var a=OpenLayers.Renderer.Elements.prototype.setExtent.apply(this,arguments);var d=this.getResolution();var c=(k.left/d)|0;var h=(k.top/d-this.size.h)|0;if(b||!this.offset){this.offset={x:c,y:h};c=0;h=0}else{c=c-this.offset.x;h=h-this.offset.y}var m=(c-this.xOffset)+" "+h;this.root.coordorigin=m;var j=[this.root,this.vectorRoot,this.textRoot];var g;for(var e=0,f=j.length;e<f;++e){g=j[e];var l=this.size.w+" "+this.size.h;g.coordsize=l}this.root.style.flip="y";return a},setSize:function(f){OpenLayers.Renderer.prototype.setSize.apply(this,arguments);var d=[this.rendererRoot,this.root,this.vectorRoot,this.textRoot];var c=this.size.w+"px";var g=this.size.h+"px";var b;for(var e=0,a=d.length;e<a;++e){b=d[e];b.style.width=c;b.style.height=g}},getNodeType:function(c,b){var a=null;switch(c.CLASS_NAME){case"OpenLayers.Geometry.Point":if(b.externalGraphic){a="olv:rect"}else{if(this.isComplexSymbol(b.graphicName)){a="olv:shape"}else{a="olv:oval"}}break;case"OpenLayers.Geometry.Rectangle":a="olv:rect";break;case"OpenLayers.Geometry.LineString":case"OpenLayers.Geometry.LinearRing":case"OpenLayers.Geometry.Polygon":case"OpenLayers.Geometry.Curve":a="olv:shape";break;default:break}return a},setStyle:function(k,o,a,c){o=o||k._style;a=a||k._options;var b=o.fillColor;var r=o.title||o.graphicTitle;if(r){k.title=r}if(k._geometryClass==="OpenLayers.Geometry.Point"){if(o.externalGraphic){a.isFilled=true;var j=o.graphicWidth||o.graphicHeight;var h=o.graphicHeight||o.graphicWidth;j=j?j:o.pointRadius*2;h=h?h:o.pointRadius*2;var m=this.getResolution();var q=(o.graphicXOffset!=undefined)?o.graphicXOffset:-(0.5*j);var e=(o.graphicYOffset!=undefined)?o.graphicYOffset:-(0.5*h);k.style.left=((((c.x-this.featureDx)/m-this.offset.x)+q)|0)+"px";k.style.top=(((c.y/m-this.offset.y)-(e+h))|0)+"px";k.style.width=j+"px";k.style.height=h+"px";k.style.flip="y";b="none";a.isStroked=false}else{if(this.isComplexSymbol(o.graphicName)){var f=this.importSymbol(o.graphicName);k.path=f.path;k.coordorigin=f.left+","+f.bottom;var g=f.size;k.coordsize=g+","+g;this.drawCircle(k,c,o.pointRadius);k.style.flip="y"}else{this.drawCircle(k,c,o.pointRadius)}}}if(a.isFilled){k.fillcolor=b}else{k.filled="false"}var i=k.getElementsByTagName("fill");var n=(i.length==0)?null:i[0];if(!a.isFilled){if(n){k.removeChild(n)}}else{if(!n){n=this.createNode("olv:fill",k.id+"_fill")}n.opacity=o.fillOpacity;if(k._geometryClass==="OpenLayers.Geometry.Point"&&o.externalGraphic){if(o.graphicOpacity){n.opacity=o.graphicOpacity}n.src=o.externalGraphic;n.type="frame";if(!(o.graphicWidth&&o.graphicHeight)){n.aspect="atmost"}}if(n.parentNode!=k){k.appendChild(n)}}var l=o.rotation;if((l!==undefined||k._rotation!==undefined)){k._rotation=l;if(o.externalGraphic){this.graphicRotate(k,q,e,o);n.opacity=0}else{if(k._geometryClass==="OpenLayers.Geometry.Point"){k.style.rotation=l||0}}}var p=k.getElementsByTagName("stroke");var d=(p.length==0)?null:p[0];if(!a.isStroked){k.stroked=false;if(d){d.on=false}}else{if(!d){d=this.createNode("olv:stroke",k.id+"_stroke");k.appendChild(d)}d.on=true;d.color=o.strokeColor;d.weight=o.strokeWidth+"px";d.opacity=o.strokeOpacity;d.endcap=o.strokeLinecap=="butt"?"flat":(o.strokeLinecap||"round");if(o.strokeDashstyle){d.dashstyle=this.dashStyle(o)}}if(o.cursor!="inherit"&&o.cursor!=null){k.style.cursor=o.cursor}return k},graphicRotate:function(n,r,e,q){var q=q||n._style;var o=q.rotation||0;var a,j;if(!(q.graphicWidth&&q.graphicHeight)){var s=new Image();s.onreadystatechange=OpenLayers.Function.bind(function(){if(s.readyState=="complete"||s.readyState=="interactive"){a=s.width/s.height;j=Math.max(q.pointRadius*2,q.graphicWidth||0,q.graphicHeight||0);r=r*a;q.graphicWidth=j*a;q.graphicHeight=j;this.graphicRotate(n,r,e,q)}},this);s.src=q.externalGraphic;return}else{j=Math.max(q.graphicWidth,q.graphicHeight);a=q.graphicWidth/q.graphicHeight}var m=Math.round(q.graphicWidth||j*a);var k=Math.round(q.graphicHeight||j);n.style.width=m+"px";n.style.height=k+"px";var l=document.getElementById(n.id+"_image");if(!l){l=this.createNode("olv:imagedata",n.id+"_image");n.appendChild(l)}l.style.width=m+"px";l.style.height=k+"px";l.src=q.externalGraphic;l.style.filter="progid:DXImageTransform.Microsoft.AlphaImageLoader(src='', sizingMethod='scale')";var f=o*Math.PI/180;var h=Math.sin(f);var d=Math.cos(f);var g="progid:DXImageTransform.Microsoft.Matrix(M11="+d+",M12="+(-h)+",M21="+h+",M22="+d+",SizingMethod='auto expand')\n";var b=q.graphicOpacity||q.fillOpacity;if(b&&b!=1){g+="progid:DXImageTransform.Microsoft.BasicImage(opacity="+b+")\n"}n.style.filter=g;var p=new OpenLayers.Geometry.Point(-r,-e);var c=new OpenLayers.Bounds(0,0,m,k).toGeometry();c.rotate(q.rotation,p);var i=c.getBounds();n.style.left=Math.round(parseInt(n.style.left)+i.left)+"px";n.style.top=Math.round(parseInt(n.style.top)-i.bottom)+"px"},postDraw:function(a){a.style.visibility="visible";var c=a._style.fillColor;var b=a._style.strokeColor;if(c=="none"&&a.fillcolor!=c){a.fillcolor=c}if(b=="none"&&a.strokecolor!=b){a.strokecolor=b}},setNodeDimension:function(b,e){var d=e.getBounds();if(d){var a=this.getResolution();var c=new OpenLayers.Bounds(((d.left-this.featureDx)/a-this.offset.x)|0,(d.bottom/a-this.offset.y)|0,((d.right-this.featureDx)/a-this.offset.x)|0,(d.top/a-this.offset.y)|0);b.style.left=c.left+"px";b.style.top=c.top+"px";b.style.width=c.getWidth()+"px";b.style.height=c.getHeight()+"px";b.coordorigin=c.left+" "+c.top;b.coordsize=c.getWidth()+" "+c.getHeight()}},dashStyle:function(a){var c=a.strokeDashstyle;switch(c){case"solid":case"dot":case"dash":case"dashdot":case"longdash":case"longdashdot":return c;default:var b=c.split(/[ ,]/);if(b.length==2){if(1*b[0]>=2*b[1]){return"longdash"}return(b[0]==1||b[1]==1)?"dot":"dash"}else{if(b.length==4){return(1*b[0]>=2*b[1])?"longdashdot":"dashdot"}}return"solid"}},createNode:function(a,c){var b=document.createElement(a);if(c){b.id=c}b.unselectable="on";b.onselectstart=OpenLayers.Function.False;return b},nodeTypeCompare:function(c,b){var d=b;var a=d.indexOf(":");if(a!=-1){d=d.substr(a+1)}var e=c.nodeName;a=e.indexOf(":");if(a!=-1){e=e.substr(a+1)}return(d==e)},createRenderRoot:function(){return this.nodeFactory(this.container.id+"_vmlRoot","div")},createRoot:function(a){return this.nodeFactory(this.container.id+a,"olv:group")},drawPoint:function(a,b){return this.drawCircle(a,b,1)},drawCircle:function(d,e,a){if(!isNaN(e.x)&&!isNaN(e.y)){var b=this.getResolution();d.style.left=((((e.x-this.featureDx)/b-this.offset.x)|0)-a)+"px";d.style.top=(((e.y/b-this.offset.y)|0)-a)+"px";var c=a*2;d.style.width=c+"px";d.style.height=c+"px";return d}return false},drawLineString:function(a,b){return this.drawLine(a,b,false)},drawLinearRing:function(a,b){return this.drawLine(a,b,true)},drawLine:function(b,k,g){this.setNodeDimension(b,k);var c=this.getResolution();var a=k.components.length;var e=new Array(a);var h,l,j;for(var f=0;f<a;f++){h=k.components[f];l=((h.x-this.featureDx)/c-this.offset.x)|0;j=(h.y/c-this.offset.y)|0;e[f]=" "+l+","+j+" l "}var d=(g)?" x e":" e";b.path="m"+e.join("")+d;return b},drawPolygon:function(c,m){this.setNodeDimension(c,m);var d=this.getResolution();var r=[];var e,k,o,a,g,b,f,q,h,p,n,l;for(e=0,k=m.components.length;e<k;e++){r.push("m");o=m.components[e].components;a=(e===0);g=null;b=null;for(f=0,q=o.length;f<q;f++){h=o[f];n=((h.x-this.featureDx)/d-this.offset.x)|0;l=(h.y/d-this.offset.y)|0;p=" "+n+","+l;r.push(p);if(f==0){r.push(" l")}if(!a){if(!g){g=p}else{if(g!=p){if(!b){b=p}else{if(b!=p){a=true}}}}}}r.push(a?" x ":" ")}r.push("e");c.path=r.join("");return c},drawRectangle:function(b,c){var a=this.getResolution();b.style.left=(((c.x-this.featureDx)/a-this.offset.x)|0)+"px";b.style.top=((c.y/a-this.offset.y)|0)+"px";b.style.width=((c.width/a)|0)+"px";b.style.height=((c.height/a)|0)+"px";return b},drawText:function(d,a,h){var g=this.nodeFactory(d+this.LABEL_ID_SUFFIX,"olv:rect");var f=this.nodeFactory(d+this.LABEL_ID_SUFFIX+"_textbox","olv:textbox");var c=this.getResolution();g.style.left=(((h.x-this.featureDx)/c-this.offset.x)|0)+"px";g.style.top=((h.y/c-this.offset.y)|0)+"px";g.style.flip="y";f.innerText=a.label;if(a.cursor!="inherit"&&a.cursor!=null){f.style.cursor=a.cursor}if(a.fontColor){f.style.color=a.fontColor}if(a.fontOpacity){f.style.filter="alpha(opacity="+(a.fontOpacity*100)+")"}if(a.fontFamily){f.style.fontFamily=a.fontFamily}if(a.fontSize){f.style.fontSize=a.fontSize}if(a.fontWeight){f.style.fontWeight=a.fontWeight}if(a.fontStyle){f.style.fontStyle=a.fontStyle}if(a.labelSelect===true){g._featureId=d;f._featureId=d;f._geometry=h;f._geometryClass=h.CLASS_NAME}f.style.whiteSpace="nowrap";f.inset="1px,0px,0px,0px";if(!g.parentNode){g.appendChild(f);this.textRoot.appendChild(g)}var e=a.labelAlign||"cm";if(e.length==1){e+="m"}var i=f.clientWidth*(OpenLayers.Renderer.VML.LABEL_SHIFT[e.substr(0,1)]);var b=f.clientHeight*(OpenLayers.Renderer.VML.LABEL_SHIFT[e.substr(1,1)]);g.style.left=parseInt(g.style.left)-i-1+"px";g.style.top=parseInt(g.style.top)+b+"px"},moveRoot:function(b){var a=this.map.getLayer(b.container.id);if(a instanceof OpenLayers.Layer.Vector.RootContainer){a=this.map.getLayer(this.container.id)}a&&a.renderer.clear();OpenLayers.Renderer.Elements.prototype.moveRoot.apply(this,arguments);a&&a.redraw()},importSymbol:function(d){var b=this.container.id+"-"+d;var a=this.symbolCache[b];if(a){return a}var c=OpenLayers.Renderer.symbol[d];if(!c){throw new Error(d+" is not a valid symbol name")}var k=new OpenLayers.Bounds(Number.MAX_VALUE,Number.MAX_VALUE,0,0);var e=["m"];for(var f=0;f<c.length;f=f+2){var h=c[f];var g=c[f+1];k.left=Math.min(k.left,h);k.bottom=Math.min(k.bottom,g);k.right=Math.max(k.right,h);k.top=Math.max(k.top,g);e.push(h);e.push(g);if(f==0){e.push("l")}}e.push("x e");var l=e.join(" ");var j=(k.getWidth()-k.getHeight())/2;if(j>0){k.bottom=k.bottom-j;k.top=k.top+j}else{k.left=k.left+j;k.right=k.right-j}a={path:l,size:k.getWidth(),left:k.left,bottom:k.bottom};this.symbolCache[b]=a;return a},CLASS_NAME:"OpenLayers.Renderer.VML"});OpenLayers.Renderer.VML.LABEL_SHIFT={l:0,c:0.5,r:1,t:0,m:0.5,b:1};