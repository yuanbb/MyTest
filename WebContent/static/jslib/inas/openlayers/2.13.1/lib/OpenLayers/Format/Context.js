OpenLayers.Format.Context=OpenLayers.Class(OpenLayers.Format.XML.VersionedOGC,{layerOptions:null,layerParams:null,read:function(d,b){var c=OpenLayers.Format.XML.VersionedOGC.prototype.read.apply(this,arguments);var e;if(b&&b.map){this.context=c;if(b.map instanceof OpenLayers.Map){e=this.mergeContextToMap(c,b.map)}else{var a=b.map;if(OpenLayers.Util.isElement(a)||typeof a=="string"){a={div:a}}e=this.contextToMap(c,a)}}else{e=c}return e},getLayerFromContext:function(g){var c,f;var j={queryable:g.queryable,visibility:g.visibility,maxExtent:g.maxExtent,metadata:OpenLayers.Util.applyDefaults(g.metadata,{styles:g.styles,formats:g.formats,"abstract":g["abstract"],dataURL:g.dataURL}),numZoomLevels:g.numZoomLevels,units:g.units,isBaseLayer:g.isBaseLayer,opacity:g.opacity,displayInLayerSwitcher:g.displayInLayerSwitcher,singleTile:g.singleTile,tileSize:(g.tileSize)?new OpenLayers.Size(g.tileSize.width,g.tileSize.height):undefined,minScale:g.minScale||g.maxScaleDenominator,maxScale:g.maxScale||g.minScaleDenominator,srs:g.srs,dimensions:g.dimensions,metadataURL:g.metadataURL};if(this.layerOptions){OpenLayers.Util.applyDefaults(j,this.layerOptions)}var b={layers:g.name,transparent:g.transparent,version:g.version};if(g.formats&&g.formats.length>0){b.format=g.formats[0].value;for(c=0,f=g.formats.length;c<f;c++){var h=g.formats[c];if(h.current==true){b.format=h.value;break}}}if(g.styles&&g.styles.length>0){for(c=0,f=g.styles.length;c<f;c++){var a=g.styles[c];if(a.current==true){if(a.href){b.sld=a.href}else{if(a.body){b.sld_body=a.body}else{b.styles=a.name}}break}}}if(this.layerParams){OpenLayers.Util.applyDefaults(b,this.layerParams)}var d=null;var e=g.service;if(e==OpenLayers.Format.Context.serviceTypes.WFS){j.strategies=[new OpenLayers.Strategy.BBOX()];j.protocol=new OpenLayers.Protocol.WFS({url:g.url,featurePrefix:g.name.split(":")[0],featureType:g.name.split(":").pop()});d=new OpenLayers.Layer.Vector(g.title||g.name,j)}else{if(e==OpenLayers.Format.Context.serviceTypes.KML){j.strategies=[new OpenLayers.Strategy.Fixed()];j.protocol=new OpenLayers.Protocol.HTTP({url:g.url,format:new OpenLayers.Format.KML()});d=new OpenLayers.Layer.Vector(g.title||g.name,j)}else{if(e==OpenLayers.Format.Context.serviceTypes.GML){j.strategies=[new OpenLayers.Strategy.Fixed()];j.protocol=new OpenLayers.Protocol.HTTP({url:g.url,format:new OpenLayers.Format.GML()});d=new OpenLayers.Layer.Vector(g.title||g.name,j)}else{if(g.features){d=new OpenLayers.Layer.Vector(g.title||g.name,j);d.addFeatures(g.features)}else{if(g.categoryLayer!==true){d=new OpenLayers.Layer.WMS(g.title||g.name,g.url,b,j)}}}}}return d},getLayersFromContext:function(d){var e=[];for(var c=0,a=d.length;c<a;c++){var b=this.getLayerFromContext(d[c]);if(b!==null){e.push(b)}}return e},contextToMap:function(c,a){a=OpenLayers.Util.applyDefaults({maxExtent:c.maxExtent,projection:c.projection,units:c.units},a);if(a.maxExtent){a.maxResolution=a.maxExtent.getWidth()/OpenLayers.Map.TILE_WIDTH}var b={contactInformation:c.contactInformation,"abstract":c["abstract"],keywords:c.keywords,logo:c.logo,descriptionURL:c.descriptionURL};a.metadata=b;var d=new OpenLayers.Map(a);d.addLayers(this.getLayersFromContext(c.layersContext));d.setCenter(c.bounds.getCenterLonLat(),d.getZoomForExtent(c.bounds,true));return d},mergeContextToMap:function(a,b){b.addLayers(this.getLayersFromContext(a.layersContext));return b},write:function(b,a){b=this.toContext(b);return OpenLayers.Format.XML.VersionedOGC.prototype.write.apply(this,arguments)},CLASS_NAME:"OpenLayers.Format.Context"});OpenLayers.Format.Context.serviceTypes={WMS:"urn:ogc:serviceType:WMS",WFS:"urn:ogc:serviceType:WFS",WCS:"urn:ogc:serviceType:WCS",GML:"urn:ogc:serviceType:GML",SLD:"urn:ogc:serviceType:SLD",FES:"urn:ogc:serviceType:FES",KML:"urn:ogc:serviceType:KML"};