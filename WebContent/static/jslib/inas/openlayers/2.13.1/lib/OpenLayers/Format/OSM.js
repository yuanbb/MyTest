OpenLayers.Format.OSM=OpenLayers.Class(OpenLayers.Format.XML,{checkTags:false,interestingTagsExclude:null,areaTags:null,initialize:function(a){var d={interestingTagsExclude:["source","source_ref","source:ref","history","attribution","created_by"],areaTags:["area","building","leisure","tourism","ruins","historic","landuse","military","natural","sport"]};d=OpenLayers.Util.extend(d,a);var e={};for(var b=0;b<d.interestingTagsExclude.length;b++){e[d.interestingTagsExclude[b]]=true}d.interestingTagsExclude=e;var c={};for(var b=0;b<d.areaTags.length;b++){c[d.areaTags[b]]=true}d.areaTags=c;this.externalProjection=new OpenLayers.Projection("EPSG:4326");OpenLayers.Format.XML.prototype.initialize.apply(this,[d])},read:function(n){if(typeof n=="string"){n=OpenLayers.Format.XML.prototype.read.apply(this,[n])}var b=this.getNodes(n);var o=this.getWays(n);var g=new Array(o.length);for(var f=0;f<o.length;f++){var l=new Array(o[f].nodes.length);var a=this.isWayArea(o[f])?1:0;for(var e=0;e<o[f].nodes.length;e++){var c=b[o[f].nodes[e]];var m=new OpenLayers.Geometry.Point(c.lon,c.lat);m.osm_id=parseInt(o[f].nodes[e]);l[e]=m;c.used=true}var k=null;if(a){k=new OpenLayers.Geometry.Polygon(new OpenLayers.Geometry.LinearRing(l))}else{k=new OpenLayers.Geometry.LineString(l)}if(this.internalProjection&&this.externalProjection){k.transform(this.externalProjection,this.internalProjection)}var h=new OpenLayers.Feature.Vector(k,o[f].tags);h.osm_id=parseInt(o[f].id);h.fid="way."+h.osm_id;g[f]=h}for(var d in b){var c=b[d];if(!c.used||this.checkTags){var q=null;if(this.checkTags){var p=this.getTags(c.node,true);if(c.used&&!p[1]){continue}q=p[0]}else{q=this.getTags(c.node)}var h=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(c.lon,c.lat),q);if(this.internalProjection&&this.externalProjection){h.geometry.transform(this.externalProjection,this.internalProjection)}h.osm_id=parseInt(d);h.fid="node."+h.osm_id;g.push(h)}c.node=null}return g},getNodes:function(e){var d=e.getElementsByTagName("node");var a={};for(var b=0;b<d.length;b++){var c=d[b];var f=c.getAttribute("id");a[f]={lat:c.getAttribute("lat"),lon:c.getAttribute("lon"),node:c}}return a},getWays:function(g){var f=g.getElementsByTagName("way");var h=[];for(var d=0;d<f.length;d++){var b=f[d];var c={id:b.getAttribute("id")};c.tags=this.getTags(b);var e=b.getElementsByTagName("nd");c.nodes=new Array(e.length);for(var a=0;a<e.length;a++){c.nodes[a]=e[a].getAttribute("ref")}h.push(c)}return h},getTags:function(e,g){var a=e.getElementsByTagName("tag");var c={};var f=false;for(var b=0;b<a.length;b++){var d=a[b].getAttribute("k");c[d]=a[b].getAttribute("v");if(g){if(!this.interestingTagsExclude[d]){f=true}}}return g?[c,f]:c},isWayArea:function(b){var a=false;var d=false;if(b.nodes[0]==b.nodes[b.nodes.length-1]){a=true}if(this.checkTags){for(var c in b.tags){if(this.areaTags[c]){d=true;break}}}return a&&(this.checkTags?d:true)},write:function(d){if(!(OpenLayers.Util.isArray(d))){d=[d]}this.osm_id=1;this.created_nodes={};var e=this.createElementNS(null,"osm");e.setAttribute("version","0.5");e.setAttribute("generator","OpenLayers "+OpenLayers.VERSION_NUMBER);for(var c=d.length-1;c>=0;c--){var a=this.createFeatureNodes(d[c]);for(var b=0;b<a.length;b++){e.appendChild(a[b])}}return OpenLayers.Format.XML.prototype.write.apply(this,[e])},createFeatureNodes:function(c){var b=[];var e=c.geometry.CLASS_NAME;var d=e.substring(e.lastIndexOf(".")+1);d=d.toLowerCase();var a=this.createXML[d];if(a){b=a.apply(this,[c])}return b},createXML:{point:function(a){var e=null;var c=a.geometry?a.geometry:a;if(this.internalProjection&&this.externalProjection){c=c.clone();c.transform(this.internalProjection,this.externalProjection)}var d=false;if(a.osm_id){e=a.osm_id;if(this.created_nodes[e]){d=true}}else{e=-this.osm_id;this.osm_id++}if(d){b=this.created_nodes[e]}else{var b=this.createElementNS(null,"node")}this.created_nodes[e]=b;b.setAttribute("id",e);b.setAttribute("lon",c.x);b.setAttribute("lat",c.y);if(a.attributes){this.serializeTags(a,b)}this.setState(a,b);return d?[]:[b]},linestring:function(j){var b;var a=[];var f=j.geometry;if(j.osm_id){b=j.osm_id}else{b=-this.osm_id;this.osm_id++}var h=this.createElementNS(null,"way");h.setAttribute("id",b);for(var d=0;d<f.components.length;d++){var c=this.createXML.point.apply(this,[f.components[d]]);if(c.length){c=c[0];var g=c.getAttribute("id");a.push(c)}else{g=f.components[d].osm_id;c=this.created_nodes[g]}this.setState(j,c);var e=this.createElementNS(null,"nd");e.setAttribute("ref",g);h.appendChild(e)}this.serializeTags(j,h);a.push(h);return a},polygon:function(b){var a=OpenLayers.Util.extend({area:"yes"},b.attributes);var c=new OpenLayers.Feature.Vector(b.geometry.components[0],a);c.osm_id=b.osm_id;return this.createXML.linestring.apply(this,[c])}},serializeTags:function(c,d){for(var b in c.attributes){var a=this.createElementNS(null,"tag");a.setAttribute("k",b);a.setAttribute("v",c.attributes[b]);d.appendChild(a)}},setState:function(a,b){if(a.state){var c=null;switch(a.state){case OpenLayers.State.UPDATE:c="modify";case OpenLayers.State.DELETE:c="delete"}if(c){b.setAttribute("action",c)}}},CLASS_NAME:"OpenLayers.Format.OSM"});