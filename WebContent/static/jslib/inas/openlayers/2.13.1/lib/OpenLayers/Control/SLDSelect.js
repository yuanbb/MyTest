OpenLayers.Control.SLDSelect=OpenLayers.Class(OpenLayers.Control,{clearOnDeactivate:false,layers:null,callbacks:null,selectionSymbolizer:{Polygon:{fillColor:"#FF0000",stroke:false},Line:{strokeColor:"#FF0000",strokeWidth:2},Point:{graphicName:"square",fillColor:"#FF0000",pointRadius:5}},layerOptions:null,sketchStyle:null,wfsCache:{},layerCache:{},initialize:function(b,a){OpenLayers.Control.prototype.initialize.apply(this,[a]);this.callbacks=OpenLayers.Util.extend({done:this.select,click:this.select},this.callbacks);this.handlerOptions=this.handlerOptions||{};this.layerOptions=OpenLayers.Util.applyDefaults(this.layerOptions,{displayInLayerSwitcher:false,tileOptions:{maxGetUrlLength:2048}});if(this.sketchStyle){this.handlerOptions.layerOptions=OpenLayers.Util.applyDefaults(this.handlerOptions.layerOptions,{styleMap:new OpenLayers.StyleMap({"default":this.sketchStyle})})}this.handler=new b(this,this.callbacks,this.handlerOptions)},destroy:function(){for(var a in this.layerCache){delete this.layerCache[a]}for(var a in this.wfsCache){delete this.wfsCache[a]}OpenLayers.Control.prototype.destroy.apply(this,arguments)},coupleLayerVisiblity:function(a){this.setVisibility(a.object.getVisibility())},createSelectionLayer:function(b){var a;if(!this.layerCache[b.id]){a=new OpenLayers.Layer.WMS(b.name,b.url,b.params,OpenLayers.Util.applyDefaults(this.layerOptions,b.getOptions()));this.layerCache[b.id]=a;if(this.layerOptions.displayInLayerSwitcher===false){b.events.on({visibilitychanged:this.coupleLayerVisiblity,scope:a})}this.map.addLayer(a)}else{a=this.layerCache[b.id]}return a},createSLD:function(f,d,g){var a={version:"1.0.0",namedLayers:{}};var j=[f.params.LAYERS].join(",").split(",");for(var e=0,h=j.length;e<h;e++){var b=j[e];a.namedLayers[b]={name:b,userStyles:[]};var l=this.selectionSymbolizer;var k=g[e];if(k.type.indexOf("Polygon")>=0){l={Polygon:this.selectionSymbolizer.Polygon}}else{if(k.type.indexOf("LineString")>=0){l={Line:this.selectionSymbolizer.Line}}else{if(k.type.indexOf("Point")>=0){l={Point:this.selectionSymbolizer.Point}}}}var c=d[e];a.namedLayers[b].userStyles.push({name:"default",rules:[new OpenLayers.Rule({symbolizer:l,filter:c,maxScaleDenominator:f.options.minScale})]})}return new OpenLayers.Format.SLD({srsName:this.map.getProjection()}).write(a)},parseDescribeLayer:function(c){var g=new OpenLayers.Format.WMSDescribeLayer();var h=c.responseXML;if(!h||!h.documentElement){h=c.responseText}var b=g.read(h);var f=[];var a=null;for(var d=0,e=b.length;d<e;d++){if(b[d].owsType=="WFS"){f.push(b[d].typeName);a=b[d].owsURL}}var j={url:a,params:{SERVICE:"WFS",TYPENAME:f.toString(),REQUEST:"DescribeFeatureType",VERSION:"1.0.0"},callback:function(k){var m=new OpenLayers.Format.WFSDescribeFeatureType();var l=k.responseXML;if(!l||!l.documentElement){l=k.responseText}var i=m.read(l);this.control.wfsCache[this.layer.id]=i;this.control._queue&&this.control.applySelection()},scope:this};OpenLayers.Request.GET(j)},getGeometryAttributes:function(d){var m=[];var a=this.wfsCache[d.id];for(var c=0,e=a.featureTypes.length;c<e;c++){var h=a.featureTypes[c];var f=h.properties;for(var b=0,l=f.length;b<l;b++){var k=f[b];var g=k.type;if((g.indexOf("LineString")>=0)||(g.indexOf("GeometryAssociationType")>=0)||(g.indexOf("GeometryPropertyType")>=0)||(g.indexOf("Point")>=0)||(g.indexOf("Polygon")>=0)){m.push(k)}}}return m},activate:function(){var b=OpenLayers.Control.prototype.activate.call(this);if(b){for(var e=0,a=this.layers.length;e<a;e++){var d=this.layers[e];if(d&&!this.wfsCache[d.id]){var c={url:d.url,params:{SERVICE:"WMS",VERSION:d.params.VERSION,LAYERS:d.params.LAYERS,REQUEST:"DescribeLayer"},callback:this.parseDescribeLayer,scope:{layer:d,control:this}};OpenLayers.Request.GET(c)}}}return b},deactivate:function(){var f=OpenLayers.Control.prototype.deactivate.call(this);if(f){for(var e=0,a=this.layers.length;e<a;e++){var d=this.layers[e];if(d&&this.clearOnDeactivate===true){var c=this.layerCache;var b=c[d.id];if(b){d.events.un({visibilitychanged:this.coupleLayerVisiblity,scope:b});b.destroy();delete c[d.id]}}}}return f},setLayers:function(a){if(this.active){this.deactivate();this.layers=a;this.activate()}else{this.layers=a}},createFilter:function(a,c){var b=null;if(this.handler instanceof OpenLayers.Handler.RegularPolygon){if(this.handler.irregular===true){b=new OpenLayers.Filter.Spatial({type:OpenLayers.Filter.Spatial.BBOX,property:a.name,value:c.getBounds()})}else{b=new OpenLayers.Filter.Spatial({type:OpenLayers.Filter.Spatial.INTERSECTS,property:a.name,value:c})}}else{if(this.handler instanceof OpenLayers.Handler.Polygon){b=new OpenLayers.Filter.Spatial({type:OpenLayers.Filter.Spatial.INTERSECTS,property:a.name,value:c})}else{if(this.handler instanceof OpenLayers.Handler.Path){if(a.type.indexOf("Point")>=0){b=new OpenLayers.Filter.Spatial({type:OpenLayers.Filter.Spatial.DWITHIN,property:a.name,distance:this.map.getExtent().getWidth()*0.01,distanceUnits:this.map.getUnits(),value:c})}else{b=new OpenLayers.Filter.Spatial({type:OpenLayers.Filter.Spatial.INTERSECTS,property:a.name,value:c})}}else{if(this.handler instanceof OpenLayers.Handler.Click){if(a.type.indexOf("Polygon")>=0){b=new OpenLayers.Filter.Spatial({type:OpenLayers.Filter.Spatial.INTERSECTS,property:a.name,value:c})}else{b=new OpenLayers.Filter.Spatial({type:OpenLayers.Filter.Spatial.DWITHIN,property:a.name,distance:this.map.getExtent().getWidth()*0.01,distanceUnits:this.map.getUnits(),value:c})}}}}}return b},select:function(a){this._queue=function(){for(var g=0,l=this.layers.length;g<l;g++){var h=this.layers[g];var k=this.getGeometryAttributes(h);var d=[];for(var f=0,n=k.length;f<n;f++){var o=k[f];if(o!==null){if(!(a instanceof OpenLayers.Geometry)){var m=this.map.getLonLatFromPixel(a.xy);a=new OpenLayers.Geometry.Point(m.lon,m.lat)}var c=this.createFilter(o,a);if(c!==null){d.push(c)}}}var e=this.createSelectionLayer(h);this.events.triggerEvent("selected",{layer:h,filters:d});var b=this.createSLD(h,d,k);e.mergeNewParams({SLD_BODY:b});delete this._queue}};this.applySelection()},applySelection:function(){var c=true;for(var b=0,a=this.layers.length;b<a;b++){if(!this.wfsCache[this.layers[b].id]){c=false;break}}c&&this._queue.call(this)},CLASS_NAME:"OpenLayers.Control.SLDSelect"});