OpenLayers.Handler.Path=OpenLayers.Class(OpenLayers.Handler.Point,{line:null,maxVertices:null,doubleTouchTolerance:20,freehand:false,freehandToggle:"shiftKey",timerId:null,redoStack:null,createFeature:function(a){var b=this.layer.getLonLatFromViewPortPx(a);var c=new OpenLayers.Geometry.Point(b.lon,b.lat);this.point=new OpenLayers.Feature.Vector(c);this.line=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.LineString([this.point.geometry]));this.callback("create",[this.point.geometry,this.getSketch()]);this.point.geometry.clearBounds();this.layer.addFeatures([this.line,this.point],{silent:true})},destroyFeature:function(a){OpenLayers.Handler.Point.prototype.destroyFeature.call(this,a);this.line=null},destroyPersistedFeature:function(){var a=this.layer;if(a&&a.features.length>2){this.layer.features[0].destroy()}},removePoint:function(){if(this.point){this.layer.removeFeatures([this.point])}},addPoint:function(a){this.layer.removeFeatures([this.point]);var b=this.layer.getLonLatFromViewPortPx(a);this.point=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(b.lon,b.lat));this.line.geometry.addComponent(this.point.geometry,this.line.geometry.components.length);this.layer.addFeatures([this.point]);this.callback("point",[this.point.geometry,this.getGeometry()]);this.callback("modify",[this.point.geometry,this.getSketch()]);this.drawFeature();delete this.redoStack},insertXY:function(a,b){this.line.geometry.addComponent(new OpenLayers.Geometry.Point(a,b),this.getCurrentPointIndex());this.drawFeature();delete this.redoStack},insertDeltaXY:function(b,a){var c=this.getCurrentPointIndex()-1;var d=this.line.geometry.components[c];if(d&&!isNaN(d.x)&&!isNaN(d.y)){this.insertXY(d.x+b,d.y+a)}},insertDirectionLength:function(d,c){d*=Math.PI/180;var b=c*Math.cos(d);var a=c*Math.sin(d);this.insertDeltaXY(b,a)},insertDeflectionLength:function(c,b){var d=this.getCurrentPointIndex()-1;if(d>0){var e=this.line.geometry.components[d];var f=this.line.geometry.components[d-1];var a=Math.atan2(e.y-f.y,e.x-f.x);this.insertDirectionLength((a*180/Math.PI)+c,b)}},getCurrentPointIndex:function(){return this.line.geometry.components.length-1},undo:function(){var h=this.line.geometry;var e=h.components;var b=this.getCurrentPointIndex()-1;var g=e[b];var f=h.removeComponent(g);if(f){if(this.touch&&b>0){e=h.components;var d=e[b-1];var a=this.getCurrentPointIndex();var c=e[a];c.x=d.x;c.y=d.y}if(!this.redoStack){this.redoStack=[]}this.redoStack.push(g);this.drawFeature()}return f},redo:function(){var a=this.redoStack&&this.redoStack.pop();if(a){this.line.geometry.addComponent(a,this.getCurrentPointIndex());this.drawFeature()}return !!a},freehandMode:function(a){return(this.freehandToggle&&a[this.freehandToggle])?!this.freehand:this.freehand},modifyFeature:function(b,a){if(!this.line){this.createFeature(b)}var c=this.layer.getLonLatFromViewPortPx(b);this.point.geometry.x=c.lon;this.point.geometry.y=c.lat;this.callback("modify",[this.point.geometry,this.getSketch(),a]);this.point.geometry.clearBounds();this.drawFeature()},drawFeature:function(){this.layer.drawFeature(this.line,this.style);this.layer.drawFeature(this.point,this.style)},getSketch:function(){return this.line},getGeometry:function(){var a=this.line&&this.line.geometry;if(a&&this.multi){a=new OpenLayers.Geometry.MultiLineString([a])}return a},touchstart:function(a){if(this.timerId&&this.passesTolerance(this.lastTouchPx,a.xy,this.doubleTouchTolerance)){this.finishGeometry();window.clearTimeout(this.timerId);this.timerId=null;return false}else{if(this.timerId){window.clearTimeout(this.timerId);this.timerId=null}this.timerId=window.setTimeout(OpenLayers.Function.bind(function(){this.timerId=null},this),300);return OpenLayers.Handler.Point.prototype.touchstart.call(this,a)}},down:function(a){var b=this.stopDown;if(this.freehandMode(a)){b=true;if(this.touch){this.modifyFeature(a.xy,!!this.lastUp);OpenLayers.Event.stop(a)}}if(!this.touch&&(!this.lastDown||!this.passesTolerance(this.lastDown,a.xy,this.pixelTolerance))){this.modifyFeature(a.xy,!!this.lastUp)}this.mouseDown=true;this.lastDown=a.xy;this.stoppedDown=b;return !b},move:function(a){if(this.stoppedDown&&this.freehandMode(a)){if(this.persist){this.destroyPersistedFeature()}if(this.maxVertices&&this.line&&this.line.geometry.components.length===this.maxVertices){this.removePoint();this.finalize()}else{this.addPoint(a.xy)}return false}if(!this.touch&&(!this.mouseDown||this.stoppedDown)){this.modifyFeature(a.xy,!!this.lastUp)}return true},up:function(a){if(this.mouseDown&&(!this.lastUp||!this.lastUp.equals(a.xy))){if(this.stoppedDown&&this.freehandMode(a)){if(this.persist){this.destroyPersistedFeature()}this.removePoint();this.finalize()}else{if(this.passesTolerance(this.lastDown,a.xy,this.pixelTolerance)){if(this.touch){this.modifyFeature(a.xy)}if(this.lastUp==null&&this.persist){this.destroyPersistedFeature()}this.addPoint(a.xy);this.lastUp=a.xy;if(this.line.geometry.components.length===this.maxVertices+1){this.finishGeometry()}}}}this.stoppedDown=this.stopDown;this.mouseDown=false;return !this.stopUp},finishGeometry:function(){var a=this.line.geometry.components.length-1;this.line.geometry.removeComponent(this.line.geometry.components[a]);this.removePoint();this.finalize()},dblclick:function(a){if(!this.freehandMode(a)){this.finishGeometry()}return false},CLASS_NAME:"OpenLayers.Handler.Path"});