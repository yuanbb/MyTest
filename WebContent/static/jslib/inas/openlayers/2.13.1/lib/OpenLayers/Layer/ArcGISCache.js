OpenLayers.Layer.ArcGISCache=OpenLayers.Class(OpenLayers.Layer.XYZ,{url:null,tileOrigin:null,tileSize:new OpenLayers.Size(256,256),useArcGISServer:true,type:"png",useScales:false,overrideDPI:false,initialize:function(b,c,k){OpenLayers.Layer.XYZ.prototype.initialize.apply(this,arguments);if(this.resolutions){this.serverResolutions=this.resolutions;this.maxExtent=this.getMaxExtentForResolution(this.resolutions[0])}if(this.layerInfo){var e=this.layerInfo;var g=new OpenLayers.Bounds(e.fullExtent.xmin,e.fullExtent.ymin,e.fullExtent.xmax,e.fullExtent.ymax);this.projection="EPSG:"+e.spatialReference.wkid;this.sphericalMercator=(e.spatialReference.wkid==102100);this.units=(e.units=="esriFeet")?"ft":"m";if(!!e.tileInfo){this.tileSize=new OpenLayers.Size(e.tileInfo.width||e.tileInfo.cols,e.tileInfo.height||e.tileInfo.rows);this.tileOrigin=new OpenLayers.LonLat(e.tileInfo.origin.x,e.tileInfo.origin.y);var a=new OpenLayers.Geometry.Point(g.left,g.top);var i=new OpenLayers.Geometry.Point(g.right,g.bottom);if(this.useScales){this.scales=[]}else{this.resolutions=[]}this.lods=[];for(var j in e.tileInfo.lods){if(e.tileInfo.lods.hasOwnProperty(j)){var h=e.tileInfo.lods[j];if(this.useScales){this.scales.push(h.scale)}else{this.resolutions.push(h.resolution)}var d=this.getContainingTileCoords(a,h.resolution);h.startTileCol=d.x;h.startTileRow=d.y;var f=this.getContainingTileCoords(i,h.resolution);h.endTileCol=f.x;h.endTileRow=f.y;this.lods.push(h)}}this.maxExtent=this.calculateMaxExtentWithLOD(this.lods[0]);this.serverResolutions=this.resolutions;if(this.overrideDPI&&e.tileInfo.dpi){OpenLayers.DOTS_PER_INCH=e.tileInfo.dpi}}}},getContainingTileCoords:function(a,b){return new OpenLayers.Pixel(Math.max(Math.floor((a.x-this.tileOrigin.lon)/(this.tileSize.w*b)),0),Math.max(Math.floor((this.tileOrigin.lat-a.y)/(this.tileSize.h*b)),0))},calculateMaxExtentWithLOD:function(f){var c=(f.endTileCol-f.startTileCol)+1;var b=(f.endTileRow-f.startTileRow)+1;var a=this.tileOrigin.lon+(f.startTileCol*this.tileSize.w*f.resolution);var e=a+(c*this.tileSize.w*f.resolution);var d=this.tileOrigin.lat-(f.startTileRow*this.tileSize.h*f.resolution);var g=d-(b*this.tileSize.h*f.resolution);return new OpenLayers.Bounds(a,g,e,d)},calculateMaxExtentWithExtent:function(e,d){var c=new OpenLayers.Geometry.Point(e.left,e.top);var b=new OpenLayers.Geometry.Point(e.right,e.bottom);var g=this.getContainingTileCoords(c,d);var a=this.getContainingTileCoords(b,d);var f={resolution:d,startTileCol:g.x,startTileRow:g.y,endTileCol:a.x,endTileRow:a.y};return this.calculateMaxExtentWithLOD(f)},getUpperLeftTileCoord:function(b){var a=new OpenLayers.Geometry.Point(this.maxExtent.left,this.maxExtent.top);return this.getContainingTileCoords(a,b)},getLowerRightTileCoord:function(b){var a=new OpenLayers.Geometry.Point(this.maxExtent.right,this.maxExtent.bottom);return this.getContainingTileCoords(a,b)},getMaxExtentForResolution:function(g){var c=this.getUpperLeftTileCoord(g);var f=this.getLowerRightTileCoord(g);var h=(f.x-c.x)+1;var i=(f.y-c.y)+1;var e=this.tileOrigin.lon+(c.x*this.tileSize.w*g);var b=e+(h*this.tileSize.w*g);var a=this.tileOrigin.lat-(c.y*this.tileSize.h*g);var d=a-(i*this.tileSize.h*g);return new OpenLayers.Bounds(e,d,b,a)},clone:function(a){if(a==null){a=new OpenLayers.Layer.ArcGISCache(this.name,this.url,this.options)}return OpenLayers.Layer.XYZ.prototype.clone.apply(this,[a])},initGriddedTiles:function(a){delete this._tileOrigin;OpenLayers.Layer.XYZ.prototype.initGriddedTiles.apply(this,arguments)},getMaxExtent:function(){var a=this.map.getResolution();return this.maxExtent=this.getMaxExtentForResolution(a)},getTileOrigin:function(){if(!this._tileOrigin){var a=this.getMaxExtent();this._tileOrigin=new OpenLayers.LonLat(a.left,a.bottom)}return this._tileOrigin},getURL:function(a){var i=this.getResolution();var f=(this.tileOrigin.lon+(i*this.tileSize.w/2));var e=(this.tileOrigin.lat-(i*this.tileSize.h/2));var b=a.getCenterLonLat();var m={x:b.lon,y:b.lat};var l=(Math.round(Math.abs((b.lon-f)/(i*this.tileSize.w))));var k=(Math.round(Math.abs((e-b.lat)/(i*this.tileSize.h))));var j=this.map.getZoom();if(this.lods){var h=this.lods[this.map.getZoom()];if((l<h.startTileCol||l>h.endTileCol)||(k<h.startTileRow||k>h.endTileRow)){return null}}else{var d=this.getUpperLeftTileCoord(i);var g=this.getLowerRightTileCoord(i);if((l<d.x||l>=g.x)||(k<d.y||k>=g.y)){return null}}var c=this.url;var n=""+l+k+j;if(OpenLayers.Util.isArray(c)){c=this.selectUrl(n,c)}if(this.useArcGISServer){c=c+"/tile/${z}/${y}/${x}"}else{l="C"+OpenLayers.Number.zeroPad(l,8,16);k="R"+OpenLayers.Number.zeroPad(k,8,16);j="L"+OpenLayers.Number.zeroPad(j,2,10);c=c+"/${z}/${y}/${x}."+this.type}c=OpenLayers.String.format(c,{x:l,y:k,z:j});return OpenLayers.Util.urlAppend(c,OpenLayers.Util.getParameterString(this.params))},CLASS_NAME:"OpenLayers.Layer.ArcGISCache"});