OpenLayers.Format.GPX=OpenLayers.Class(OpenLayers.Format.XML,{defaultDesc:"No description available",extractWaypoints:true,extractTracks:true,extractRoutes:true,extractAttributes:true,namespaces:{gpx:"http://www.topografix.com/GPX/1/1",xsi:"http://www.w3.org/2001/XMLSchema-instance"},schemaLocation:"http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd",creator:"OpenLayers",initialize:function(a){this.externalProjection=new OpenLayers.Projection("EPSG:4326");OpenLayers.Format.XML.prototype.initialize.apply(this,[a])},read:function(x){if(typeof x=="string"){x=OpenLayers.Format.XML.prototype.read.apply(this,[x])}var c=[];if(this.extractTracks){var t=x.getElementsByTagName("trk");for(var s=0,u=t.length;s<u;s++){var n={};if(this.extractAttributes){n=this.parseAttributes(t[s])}var h=this.getElementsByTagNameNS(t[s],t[s].namespaceURI,"trkseg");for(var r=0,f=h.length;r<f;r++){var m=this.extractSegment(h[r],"trkpt");c.push(new OpenLayers.Feature.Vector(m,n))}}}if(this.extractRoutes){var a=x.getElementsByTagName("rte");for(var q=0,p=a.length;q<p;q++){var n={};if(this.extractAttributes){n=this.parseAttributes(a[q])}var w=this.extractSegment(a[q],"rtept");c.push(new OpenLayers.Feature.Vector(w,n))}}if(this.extractWaypoints){var b=x.getElementsByTagName("wpt");for(var o=0,u=b.length;o<u;o++){var n={};if(this.extractAttributes){n=this.parseAttributes(b[o])}var e=new OpenLayers.Geometry.Point(b[o].getAttribute("lon"),b[o].getAttribute("lat"));c.push(new OpenLayers.Feature.Vector(e,n))}}if(this.internalProjection&&this.externalProjection){for(var v=0,d=c.length;v<d;v++){c[v].geometry.transform(this.externalProjection,this.internalProjection)}}return c},extractSegment:function(e,f){var d=this.getElementsByTagNameNS(e,e.namespaceURI,f);var b=[];for(var c=0,a=d.length;c<a;c++){b.push(new OpenLayers.Geometry.Point(d[c].getAttribute("lon"),d[c].getAttribute("lat")))}return new OpenLayers.Geometry.LineString(b)},parseAttributes:function(c){var a={};var e=c.firstChild,d,b;while(e){if(e.nodeType==1&&e.firstChild){d=e.firstChild;if(d.nodeType==3||d.nodeType==4){b=(e.prefix)?e.nodeName.split(":")[1]:e.nodeName;if(b!="trkseg"&&b!="rtept"){a[b]=d.nodeValue}}}e=e.nextSibling}return a},write:function(d,c){d=OpenLayers.Util.isArray(d)?d:[d];var e=this.createElementNS(this.namespaces.gpx,"gpx");e.setAttribute("version","1.1");e.setAttribute("creator",this.creator);this.setAttributes(e,{"xsi:schemaLocation":this.schemaLocation});if(c&&typeof c=="object"){e.appendChild(this.buildMetadataNode(c))}for(var b=0,a=d.length;b<a;b++){e.appendChild(this.buildFeatureNode(d[b]))}return OpenLayers.Format.XML.prototype.write.apply(this,[e])},buildMetadataNode:function(c){var b=["name","desc","author"],e=this.createElementNS(this.namespaces.gpx,"metadata");for(var a=0;a<b.length;a++){var d=b[a];if(c[d]){var f=this.createElementNS(this.namespaces.gpx,d);f.appendChild(this.createTextNode(c[d]));e.appendChild(f)}}return e},buildFeatureNode:function(d){var g=d.geometry;g=g.clone();if(this.internalProjection&&this.externalProjection){g.transform(this.internalProjection,this.externalProjection)}if(g.CLASS_NAME=="OpenLayers.Geometry.Point"){var f=this.buildWptNode(g);this.appendAttributesNode(f,d);return f}else{var b=this.createElementNS(this.namespaces.gpx,"trk");this.appendAttributesNode(b,d);var e=this.buildTrkSegNode(g);e=OpenLayers.Util.isArray(e)?e:[e];for(var c=0,a=e.length;c<a;c++){b.appendChild(e[c])}return b}},buildTrkSegNode:function(f){var e,d,b,a,c;if(f.CLASS_NAME=="OpenLayers.Geometry.LineString"||f.CLASS_NAME=="OpenLayers.Geometry.LinearRing"){e=this.createElementNS(this.namespaces.gpx,"trkseg");for(d=0,b=f.components.length;d<b;d++){a=f.components[d];e.appendChild(this.buildTrkPtNode(a))}return e}else{c=[];for(d=0,b=f.components.length;d<b;d++){c.push(this.buildTrkSegNode(f.components[d]))}return c}},buildTrkPtNode:function(a){var b=this.createElementNS(this.namespaces.gpx,"trkpt");b.setAttribute("lon",a.x);b.setAttribute("lat",a.y);return b},buildWptNode:function(b){var a=this.createElementNS(this.namespaces.gpx,"wpt");a.setAttribute("lon",b.x);a.setAttribute("lat",b.y);return a},appendAttributesNode:function(c,b){var a=this.createElementNS(this.namespaces.gpx,"name");a.appendChild(this.createTextNode(b.attributes.name||b.id));c.appendChild(a);var d=this.createElementNS(this.namespaces.gpx,"desc");d.appendChild(this.createTextNode(b.attributes.description||this.defaultDesc));c.appendChild(d)},CLASS_NAME:"OpenLayers.Format.GPX"});