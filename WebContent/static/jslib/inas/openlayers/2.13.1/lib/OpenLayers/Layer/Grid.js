OpenLayers.Layer.Grid=OpenLayers.Class(OpenLayers.Layer.HTTPRequest,{tileSize:null,tileOriginCorner:"bl",tileOrigin:null,tileOptions:null,tileClass:OpenLayers.Tile.Image,grid:null,singleTile:false,ratio:1.5,buffer:0,transitionEffect:"resize",numLoadingTiles:0,serverResolutions:null,loading:false,backBuffer:null,gridResolution:null,backBufferResolution:null,backBufferLonLat:null,backBufferTimerId:null,removeBackBufferDelay:null,className:null,gridLayout:null,rowSign:null,transitionendEvents:["transitionend","webkitTransitionEnd","otransitionend","oTransitionEnd"],initialize:function(c,b,d,a){OpenLayers.Layer.HTTPRequest.prototype.initialize.apply(this,arguments);this.grid=[];this._removeBackBuffer=OpenLayers.Function.bind(this.removeBackBuffer,this);this.initProperties();this.rowSign=this.tileOriginCorner.substr(0,1)==="t"?1:-1},initProperties:function(){if(this.options.removeBackBufferDelay===undefined){this.removeBackBufferDelay=this.singleTile?0:2500}if(this.options.className===undefined){this.className=this.singleTile?"olLayerGridSingleTile":"olLayerGrid"}},setMap:function(a){OpenLayers.Layer.HTTPRequest.prototype.setMap.call(this,a);OpenLayers.Element.addClass(this.div,this.className)},removeMap:function(a){this.removeBackBuffer()},destroy:function(){this.removeBackBuffer();this.clearGrid();this.grid=null;this.tileSize=null;OpenLayers.Layer.HTTPRequest.prototype.destroy.apply(this,arguments)},clearGrid:function(){if(this.grid){for(var f=0,b=this.grid.length;f<b;f++){var e=this.grid[f];for(var c=0,a=e.length;c<a;c++){var d=e[c];this.destroyTile(d)}}this.grid=[];this.gridResolution=null;this.gridLayout=null}},addOptions:function(b,a){var c=b.singleTile!==undefined&&b.singleTile!==this.singleTile;OpenLayers.Layer.HTTPRequest.prototype.addOptions.apply(this,arguments);if(this.map&&c){this.initProperties();this.clearGrid();this.tileSize=this.options.tileSize;this.setTileSize();this.moveTo(null,true)}},clone:function(a){if(a==null){a=new OpenLayers.Layer.Grid(this.name,this.url,this.params,this.getOptions())}a=OpenLayers.Layer.HTTPRequest.prototype.clone.apply(this,[a]);if(this.tileSize!=null){a.tileSize=this.tileSize.clone()}a.grid=[];a.gridResolution=null;a.backBuffer=null;a.backBufferTimerId=null;a.loading=false;a.numLoadingTiles=0;return a},moveTo:function(f,b,g){OpenLayers.Layer.HTTPRequest.prototype.moveTo.apply(this,arguments);f=f||this.map.getExtent();if(f!=null){var e=!this.grid.length||b;var d=this.getTilesBounds();var c=this.map.getResolution();var a=this.getServerResolution(c);if(this.singleTile){if(e||(!g&&!d.containsBounds(f))){if(b&&this.transitionEffect!=="resize"){this.removeBackBuffer()}if(!b||this.transitionEffect==="resize"){this.applyBackBuffer(c)}this.initSingleTile(f)}}else{e=e||!d.intersectsBounds(f,{worldBounds:this.map.baseLayer.wrapDateLine&&this.map.getMaxExtent()});if(e){if(b&&(this.transitionEffect==="resize"||this.gridResolution===c)){this.applyBackBuffer(c)}this.initGriddedTiles(f)}else{this.moveGriddedTiles()}}}},getTileData:function(m){var q=null,n=m.lon,l=m.lat,d=this.grid.length;if(this.map&&d){var r=this.map.getResolution(),a=this.tileSize.w,k=this.tileSize.h,j=this.grid[0][0].bounds,e=j.left,o=j.top;if(n<e){if(this.map.baseLayer.wrapDateLine){var b=this.map.getMaxExtent().getWidth();var c=Math.ceil((e-n)/b);n+=b*c}}var h=(n-e)/(r*a);var f=(o-l)/(r*k);var g=Math.floor(h);var i=Math.floor(f);if(i>=0&&i<d){var p=this.grid[i][g];if(p){q={tile:p,i:Math.floor((h-g)*a),j:Math.floor((f-i)*k)}}}}return q},destroyTile:function(a){this.removeTileMonitoringHooks(a);a.destroy()},getServerResolution:function(c){var f=Number.POSITIVE_INFINITY;c=c||this.map.getResolution();if(this.serverResolutions&&OpenLayers.Util.indexOf(this.serverResolutions,c)===-1){var d,b,e,a;for(d=this.serverResolutions.length-1;d>=0;d--){e=this.serverResolutions[d];b=Math.abs(e-c);if(b>f){break}f=b;a=e}c=a}return c},getServerZoom:function(){var a=this.getServerResolution();return this.serverResolutions?OpenLayers.Util.indexOf(this.serverResolutions,a):this.map.getZoomForResolution(a)+(this.zoomOffset||0)},applyBackBuffer:function(b){if(this.backBufferTimerId!==null){this.removeBackBuffer()}var k=this.backBuffer;if(!k){k=this.createBackBuffer();if(!k){return}if(b===this.gridResolution){this.div.insertBefore(k,this.div.firstChild)}else{this.map.baseLayer.div.parentNode.insertBefore(k,this.map.baseLayer.div)}this.backBuffer=k;var d=this.grid[0][0].bounds;this.backBufferLonLat={lon:d.left,lat:d.top};this.backBufferResolution=this.gridResolution}var h=this.backBufferResolution/b;var j=k.childNodes,g;for(var c=j.length-1;c>=0;--c){g=j[c];g.style.top=((h*g._i*g._h)|0)+"px";g.style.left=((h*g._j*g._w)|0)+"px";g.style.width=Math.round(h*g._w)+"px";g.style.height=Math.round(h*g._h)+"px"}var f=this.getViewPortPxFromLonLat(this.backBufferLonLat,b);var a=this.map.layerContainerOriginPx.x;var e=this.map.layerContainerOriginPx.y;k.style.left=Math.round(f.x-a)+"px";k.style.top=Math.round(f.y-e)+"px"},createBackBuffer:function(){var d;if(this.grid.length>0){d=document.createElement("div");d.id=this.div.id+"_bb";d.className="olBackBuffer";d.style.position="absolute";var h=this.map;d.style.zIndex=this.transitionEffect==="resize"?this.getZIndex()-1:h.Z_INDEX_BASE.BaseLayer-(h.getNumLayers()-h.getLayerIndex(this));for(var f=0,b=this.grid.length;f<b;f++){for(var e=0,a=this.grid[f].length;e<a;e++){var g=this.grid[f][e],c=this.grid[f][e].createBackBuffer();if(c){c._i=f;c._j=e;c._w=g.size.w;c._h=g.size.h;c.id=g.id+"_bb";d.appendChild(c)}}}}return d},removeBackBuffer:function(){if(this._transitionElement){for(var a=this.transitionendEvents.length-1;a>=0;--a){OpenLayers.Event.stopObserving(this._transitionElement,this.transitionendEvents[a],this._removeBackBuffer)}delete this._transitionElement}if(this.backBuffer){if(this.backBuffer.parentNode){this.backBuffer.parentNode.removeChild(this.backBuffer)}this.backBuffer=null;this.backBufferResolution=null;if(this.backBufferTimerId!==null){window.clearTimeout(this.backBufferTimerId);this.backBufferTimerId=null}}},moveByPx:function(b,a){if(!this.singleTile){this.moveGriddedTiles()}},setTileSize:function(a){if(this.singleTile){a=this.map.getSize();a.h=parseInt(a.h*this.ratio,10);a.w=parseInt(a.w*this.ratio,10)}OpenLayers.Layer.HTTPRequest.prototype.setTileSize.apply(this,[a])},getTilesBounds:function(){var d=null;var c=this.grid.length;if(c){var e=this.grid[c-1][0].bounds,b=this.grid[0].length*e.getWidth(),a=this.grid.length*e.getHeight();d=new OpenLayers.Bounds(e.left,e.bottom,e.left+b,e.bottom+a)}return d},initSingleTile:function(e){this.events.triggerEvent("retile");var a=e.getCenterLonLat();var g=e.getWidth()*this.ratio;var b=e.getHeight()*this.ratio;var f=new OpenLayers.Bounds(a.lon-(g/2),a.lat-(b/2),a.lon+(g/2),a.lat+(b/2));var c=this.map.getLayerPxFromLonLat({lon:f.left,lat:f.top});if(!this.grid.length){this.grid[0]=[]}var d=this.grid[0][0];if(!d){d=this.addTile(f,c);this.addTileMonitoringHooks(d);d.draw();this.grid[0][0]=d}else{d.moveTo(f,c)}this.removeExcessTiles(1,1);this.gridResolution=this.getServerResolution()},calculateGridLayout:function(a,j,e){var h=e*this.tileSize.w;var d=e*this.tileSize.h;var g=a.left-j.lon;var i=Math.floor(g/h)-this.buffer;var c=this.rowSign;var b=c*(j.lat-a.top+d);var f=Math[~c?"floor":"ceil"](b/d)-this.buffer*c;return{tilelon:h,tilelat:d,startcol:i,startrow:f}},getTileOrigin:function(){var b=this.tileOrigin;if(!b){var c=this.getMaxExtent();var a=({tl:["left","top"],tr:["right","top"],bl:["left","bottom"],br:["right","bottom"]})[this.tileOriginCorner];b=new OpenLayers.LonLat(c[a[0]],c[a[1]])}return b},getTileBoundsForGridIndex:function(i,e){var h=this.getTileOrigin();var d=this.gridLayout;var f=d.tilelon;var c=d.tilelat;var a=d.startcol;var g=d.startrow;var b=this.rowSign;return new OpenLayers.Bounds(h.lon+(a+e)*f,h.lat-(g+i*b)*c*b,h.lon+(a+e+1)*f,h.lat-(g+(i-1)*b)*c*b)},initGriddedTiles:function(g){this.events.triggerEvent("retile");var e=this.map.getSize();var A=this.getTileOrigin();var q=this.map.getResolution(),o=this.getServerResolution(),h=q/o,m={w:this.tileSize.w/h,h:this.tileSize.h/h};var v=Math.ceil(e.h/m.h)+2*this.buffer+1;var w=Math.ceil(e.w/m.w)+2*this.buffer+1;var p=this.calculateGridLayout(g,A,o);this.gridLayout=p;var d=p.tilelon;var j=p.tilelat;var a=this.map.layerContainerOriginPx.x;var s=this.map.layerContainerOriginPx.y;var b=this.getTileBoundsForGridIndex(0,0);var k=this.map.getViewPortPxFromLonLat(new OpenLayers.LonLat(b.left,b.top));k.x=Math.round(k.x)-a;k.y=Math.round(k.y)-s;var x=[],y=this.map.getCenter();var u=0;do{var f=this.grid[u];if(!f){f=[];this.grid.push(f)}var c=0;do{b=this.getTileBoundsForGridIndex(u,c);var n=k.clone();n.x=n.x+c*Math.round(m.w);n.y=n.y+u*Math.round(m.h);var z=f[c];if(!z){z=this.addTile(b,n);this.addTileMonitoringHooks(z);f.push(z)}else{z.moveTo(b,n,false)}var r=b.getCenterLonLat();x.push({tile:z,distance:Math.pow(r.lon-y.lon,2)+Math.pow(r.lat-y.lat,2)});c+=1}while((b.right<=g.right+d*this.buffer)||c<w);u+=1}while((b.bottom>=g.bottom-j*this.buffer)||u<v);this.removeExcessTiles(u,c);var q=this.getServerResolution();this.gridResolution=q;x.sort(function(B,i){return B.distance-i.distance});for(var t=0,l=x.length;t<l;++t){x[t].tile.draw()}},getMaxExtent:function(){return this.maxExtent},addTile:function(c,a){var b=new this.tileClass(this,a,c,null,this.tileSize,this.tileOptions);this.events.triggerEvent("addtile",{tile:b});return b},addTileMonitoringHooks:function(b){var a="olTileReplacing";b.onLoadStart=function(){if(this.loading===false){this.loading=true;this.events.triggerEvent("loadstart")}this.events.triggerEvent("tileloadstart",{tile:b});this.numLoadingTiles++;if(!this.singleTile&&this.backBuffer&&this.gridResolution===this.backBufferResolution){OpenLayers.Element.addClass(b.getTile(),a)}};b.onLoadEnd=function(e){this.numLoadingTiles--;var h=e.type==="unload";this.events.triggerEvent("tileloaded",{tile:b,aborted:h});if(!this.singleTile&&!h&&this.backBuffer&&this.gridResolution===this.backBufferResolution){var g=b.getTile();if(OpenLayers.Element.getStyle(g,"display")==="none"){var d=document.getElementById(b.id+"_bb");if(d){d.parentNode.removeChild(d)}}OpenLayers.Element.removeClass(g,a)}if(this.numLoadingTiles===0){if(this.backBuffer){if(this.backBuffer.childNodes.length===0){this.removeBackBuffer()}else{this._transitionElement=h?this.div.lastChild:b.imgDiv;var c=this.transitionendEvents;for(var f=c.length-1;f>=0;--f){OpenLayers.Event.observe(this._transitionElement,c[f],this._removeBackBuffer)}this.backBufferTimerId=window.setTimeout(this._removeBackBuffer,this.removeBackBufferDelay)}}this.loading=false;this.events.triggerEvent("loadend")}};b.onLoadError=function(){this.events.triggerEvent("tileerror",{tile:b})};b.events.on({loadstart:b.onLoadStart,loadend:b.onLoadEnd,unload:b.onLoadEnd,loaderror:b.onLoadError,scope:this})},removeTileMonitoringHooks:function(a){a.unload();a.events.un({loadstart:a.onLoadStart,loadend:a.onLoadEnd,unload:a.onLoadEnd,loaderror:a.onLoadError,scope:this})},moveGriddedTiles:function(){var a=this.buffer+1;while(true){var e=this.grid[0][0];var d={x:e.position.x+this.map.layerContainerOriginPx.x,y:e.position.y+this.map.layerContainerOriginPx.y};var b=this.getServerResolution()/this.map.getResolution();var c={w:Math.round(this.tileSize.w*b),h:Math.round(this.tileSize.h*b)};if(d.x>-c.w*(a-1)){this.shiftColumn(true,c)}else{if(d.x<-c.w*a){this.shiftColumn(false,c)}else{if(d.y>-c.h*(a-1)){this.shiftRow(true,c)}else{if(d.y<-c.h*a){this.shiftRow(false,c)}else{break}}}}}},shiftRow:function(n,l){var a=this.grid;var k=n?0:(a.length-1);var d=n?-1:1;var b=this.rowSign;var c=this.gridLayout;c.startrow+=d*b;var e=a[k];var m=a[n?"pop":"shift"]();for(var f=0,h=m.length;f<h;f++){var j=m[f];var g=e[f].position.clone();g.y+=l.h*d;j.moveTo(this.getTileBoundsForGridIndex(k,f),g)}a[n?"unshift":"push"](m)},shiftColumn:function(l,j){var a=this.grid;var h=l?0:(a[0].length-1);var c=l?-1:1;var b=this.gridLayout;b.startcol+=c;for(var d=0,f=a.length;d<f;d++){var k=a[d];var e=k[h].position.clone();var g=k[l?"pop":"shift"]();e.x+=j.w*c;g.moveTo(this.getTileBoundsForGridIndex(d,h),e);k[l?"unshift":"push"](g)}},removeExcessTiles:function(e,c){var b,a;while(this.grid.length>e){var f=this.grid.pop();for(b=0,a=f.length;b<a;b++){var d=f[b];this.destroyTile(d)}}for(b=0,a=this.grid.length;b<a;b++){while(this.grid[b].length>c){var f=this.grid[b];var d=f.pop();this.destroyTile(d)}}},onMapResize:function(){if(this.singleTile){this.clearGrid();this.setTileSize()}},getTileBounds:function(d){var c=this.maxExtent;var f=this.getResolution();var e=f*this.tileSize.w;var b=f*this.tileSize.h;var h=this.getLonLatFromViewPortPx(d);var a=c.left+(e*Math.floor((h.lon-c.left)/e));var g=c.bottom+(b*Math.floor((h.lat-c.bottom)/b));return new OpenLayers.Bounds(a,g,a+e,g+b)},CLASS_NAME:"OpenLayers.Layer.Grid"});