OpenLayers.Tile.Image=OpenLayers.Class(OpenLayers.Tile,{url:null,imgDiv:null,frame:null,imageReloadAttempts:null,layerAlphaHack:null,asyncRequestId:null,maxGetUrlLength:null,canvasContext:null,crossOriginKeyword:null,initialize:function(e,a,f,c,d,b){OpenLayers.Tile.prototype.initialize.apply(this,arguments);this.url=c;this.layerAlphaHack=this.layer.alpha&&OpenLayers.Util.alphaHack();if(this.maxGetUrlLength!=null||this.layer.gutter||this.layerAlphaHack){this.frame=document.createElement("div");this.frame.style.position="absolute";this.frame.style.overflow="hidden"}if(this.maxGetUrlLength!=null){OpenLayers.Util.extend(this,OpenLayers.Tile.Image.IFrame)}},destroy:function(){if(this.imgDiv){this.clear();this.imgDiv=null;this.frame=null}this.asyncRequestId=null;OpenLayers.Tile.prototype.destroy.apply(this,arguments)},draw:function(){var a=OpenLayers.Tile.prototype.draw.apply(this,arguments);if(a){if(this.layer!=this.layer.map.baseLayer&&this.layer.reproject){this.bounds=this.getBoundsFromBaseLayer(this.position)}if(this.isLoading){this._loadEvent="reload"}else{this.isLoading=true;this._loadEvent="loadstart"}this.renderTile();this.positionTile()}else{if(a===false){this.unload()}}return a},renderTile:function(){if(this.layer.async){var a=this.asyncRequestId=(this.asyncRequestId||0)+1;this.layer.getURLasync(this.bounds,function(b){if(a==this.asyncRequestId){this.url=b;this.initImage()}},this)}else{this.url=this.layer.getURL(this.bounds);this.initImage()}},positionTile:function(){var c=this.getTile().style,a=this.frame?this.size:this.layer.getImageSize(this.bounds),b=1;if(this.layer instanceof OpenLayers.Layer.Grid){b=this.layer.getServerResolution()/this.layer.map.getResolution()}c.left=this.position.x+"px";c.top=this.position.y+"px";c.width=Math.round(b*a.w)+"px";c.height=Math.round(b*a.h)+"px"},clear:function(){OpenLayers.Tile.prototype.clear.apply(this,arguments);var a=this.imgDiv;if(a){var b=this.getTile();if(b.parentNode===this.layer.div){this.layer.div.removeChild(b)}this.setImgSrc();if(this.layerAlphaHack===true){a.style.filter=""}OpenLayers.Element.removeClass(a,"olImageLoadError")}this.canvasContext=null},getImage:function(){if(!this.imgDiv){this.imgDiv=OpenLayers.Tile.Image.IMAGE.cloneNode(false);var a=this.imgDiv.style;if(this.frame){var c=0,b=0;if(this.layer.gutter){c=this.layer.gutter/this.layer.tileSize.w*100;b=this.layer.gutter/this.layer.tileSize.h*100}a.left=-c+"%";a.top=-b+"%";a.width=(2*c+100)+"%";a.height=(2*b+100)+"%"}a.visibility="hidden";a.opacity=0;if(this.layer.opacity<1){a.filter="alpha(opacity="+(this.layer.opacity*100)+")"}a.position="absolute";if(this.layerAlphaHack){a.paddingTop=a.height;a.height="0";a.width="100%"}if(this.frame){this.frame.appendChild(this.imgDiv)}}return this.imgDiv},setImage:function(a){this.imgDiv=a},initImage:function(){if(!this.url&&!this.imgDiv){this.isLoading=false;return}this.events.triggerEvent("beforeload");this.layer.div.appendChild(this.getTile());this.events.triggerEvent(this._loadEvent);var a=this.getImage();var b=a.getAttribute("src")||"";if(this.url&&OpenLayers.Util.isEquivalentUrl(b,this.url)){this._loadTimeout=window.setTimeout(OpenLayers.Function.bind(this.onImageLoad,this),0)}else{this.stopLoading();if(this.crossOriginKeyword){a.removeAttribute("crossorigin")}OpenLayers.Event.observe(a,"load",OpenLayers.Function.bind(this.onImageLoad,this));OpenLayers.Event.observe(a,"error",OpenLayers.Function.bind(this.onImageError,this));this.imageReloadAttempts=0;this.setImgSrc(this.url)}},setImgSrc:function(b){var a=this.imgDiv;if(b){a.style.visibility="hidden";a.style.opacity=0;if(this.crossOriginKeyword){if(b.substr(0,5)!=="data:"){a.setAttribute("crossorigin",this.crossOriginKeyword)}else{a.removeAttribute("crossorigin")}}a.src=b}else{this.stopLoading();this.imgDiv=null;if(a.parentNode){a.parentNode.removeChild(a)}}},getTile:function(){return this.frame?this.frame:this.getImage()},createBackBuffer:function(){if(!this.imgDiv||this.isLoading){return}var a;if(this.frame){a=this.frame.cloneNode(false);a.appendChild(this.imgDiv)}else{a=this.imgDiv}this.imgDiv=null;return a},onImageLoad:function(){var a=this.imgDiv;this.stopLoading();a.style.visibility="inherit";a.style.opacity=this.layer.opacity;this.isLoading=false;this.canvasContext=null;this.events.triggerEvent("loadend");if(this.layerAlphaHack===true){a.style.filter="progid:DXImageTransform.Microsoft.AlphaImageLoader(src='"+a.src+"', sizingMethod='scale')"}},onImageError:function(){var a=this.imgDiv;if(a.src!=null){this.imageReloadAttempts++;if(this.imageReloadAttempts<=OpenLayers.IMAGE_RELOAD_ATTEMPTS){this.setImgSrc(this.layer.getURL(this.bounds))}else{OpenLayers.Element.addClass(a,"olImageLoadError");this.events.triggerEvent("loaderror");this.onImageLoad()}}},stopLoading:function(){OpenLayers.Event.stopObservingElement(this.imgDiv);window.clearTimeout(this._loadTimeout);delete this._loadTimeout},getCanvasContext:function(){if(OpenLayers.CANVAS_SUPPORTED&&this.imgDiv&&!this.isLoading){if(!this.canvasContext){var a=document.createElement("canvas");a.width=this.size.w;a.height=this.size.h;this.canvasContext=a.getContext("2d");this.canvasContext.drawImage(this.imgDiv,0,0)}return this.canvasContext}},CLASS_NAME:"OpenLayers.Tile.Image"});OpenLayers.Tile.Image.IMAGE=(function(){var a=new Image();a.className="olTileImage";a.galleryImg="no";return a}());