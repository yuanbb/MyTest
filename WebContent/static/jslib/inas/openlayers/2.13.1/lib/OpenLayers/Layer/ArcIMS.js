OpenLayers.Layer.ArcIMS=OpenLayers.Class(OpenLayers.Layer.Grid,{DEFAULT_PARAMS:{ClientVersion:"9.2",ServiceName:""},featureCoordSys:"4326",filterCoordSys:"4326",layers:null,async:true,name:"ArcIMS",isBaseLayer:true,DEFAULT_OPTIONS:{tileSize:new OpenLayers.Size(512,512),featureCoordSys:"4326",filterCoordSys:"4326",layers:null,isBaseLayer:true,async:true,name:"ArcIMS"},initialize:function(c,b,a){this.tileSize=new OpenLayers.Size(512,512);this.params=OpenLayers.Util.applyDefaults({ServiceName:a.serviceName},this.DEFAULT_PARAMS);this.options=OpenLayers.Util.applyDefaults(a,this.DEFAULT_OPTIONS);OpenLayers.Layer.Grid.prototype.initialize.apply(this,[c,b,this.params,a]);if(this.transparent){if(!this.isBaseLayer){this.isBaseLayer=false}if(this.format=="image/jpeg"){this.format=OpenLayers.Util.alphaHack()?"image/gif":"image/png"}}if(this.options.layers===null){this.options.layers=[]}},getURL:function(d){var a="";d=this.adjustBounds(d);var c=new OpenLayers.Format.ArcXML(OpenLayers.Util.extend(this.options,{requesttype:"image",envelope:d.toArray(),tileSize:this.tileSize}));var b=new OpenLayers.Request.POST({url:this.getFullRequestString(),data:c.write(),async:false});if(b!=null){var f=b.responseXML;if(!f||!f.documentElement){f=b.responseText}var e=new OpenLayers.Format.ArcXML();var g=e.read(f);a=this.getUrlOrImage(g.image.output)}return a},getURLasync:function(c,d,a){c=this.adjustBounds(c);var b=new OpenLayers.Format.ArcXML(OpenLayers.Util.extend(this.options,{requesttype:"image",envelope:c.toArray(),tileSize:this.tileSize}));OpenLayers.Request.POST({url:this.getFullRequestString(),async:true,data:b.write(),callback:function(e){var g=e.responseXML;if(!g||!g.documentElement){g=e.responseText}var f=new OpenLayers.Format.ArcXML();var h=f.read(g);d.call(a,this.getUrlOrImage(h.image.output))},scope:this})},getUrlOrImage:function(a){var b="";if(a.url){b=a.url}else{if(a.data){b="data:image/"+a.type+";base64,"+a.data}}return b},setLayerQuery:function(c,a){for(var b=0;b<this.options.layers.length;b++){if(c==this.options.layers[b].id){this.options.layers[b].query=a;return}}this.options.layers.push({id:c,visible:true,query:a})},getFeatureInfo:function(h,f,k){var b=k.buffer||1;var i=k.callback||function(){};var j=k.scope||window;var a={};OpenLayers.Util.extend(a,this.options);a.requesttype="feature";if(h instanceof OpenLayers.LonLat){a.polygon=null;a.envelope=[h.lon-b,h.lat-b,h.lon+b,h.lat+b]}else{if(h instanceof OpenLayers.Geometry.Polygon){a.envelope=null;a.polygon=h}}var e=new OpenLayers.Format.ArcXML(a);OpenLayers.Util.extend(e.request.get_feature,k);e.request.get_feature.layer=f.id;if(typeof f.query.accuracy=="number"){e.request.get_feature.query.accuracy=f.query.accuracy}else{var g=this.map.getCenter();var d=this.map.getViewPortPxFromLonLat(g);d.x++;var c=this.map.getLonLatFromPixel(d);e.request.get_feature.query.accuracy=c.lon-g.lon}e.request.get_feature.query.where=f.query.where;e.request.get_feature.query.spatialfilter.relation="area_intersection";OpenLayers.Request.POST({url:this.getFullRequestString({CustomService:"Query"}),data:e.write(),callback:function(m){var l=e.parseResponse(m.responseText);if(!e.iserror()){i.call(j,l.features)}else{i.call(j,null)}}})},clone:function(a){if(a==null){a=new OpenLayers.Layer.ArcIMS(this.name,this.url,this.getOptions())}a=OpenLayers.Layer.Grid.prototype.clone.apply(this,[a]);return a},CLASS_NAME:"OpenLayers.Layer.ArcIMS"});