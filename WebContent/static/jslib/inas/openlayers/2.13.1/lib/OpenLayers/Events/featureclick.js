OpenLayers.Events.featureclick=OpenLayers.Class({cache:null,map:null,provides:["featureclick","nofeatureclick","featureover","featureout"],initialize:function(b){this.target=b;if(b.object instanceof OpenLayers.Map){this.setMap(b.object)}else{if(b.object instanceof OpenLayers.Layer.Vector){if(b.object.map){this.setMap(b.object.map)}else{b.object.events.register("added",this,function(c){this.setMap(b.object.map)})}}else{throw ("Listeners for '"+this.provides.join("', '")+"' events can only be registered for OpenLayers.Layer.Vector or OpenLayers.Map instances")}}for(var a=this.provides.length-1;a>=0;--a){b.extensions[this.provides[a]]=true}},setMap:function(a){this.map=a;this.cache={};a.events.register("mousedown",this,this.start,{extension:true});a.events.register("mouseup",this,this.onClick,{extension:true});a.events.register("touchstart",this,this.start,{extension:true});a.events.register("touchmove",this,this.cancel,{extension:true});a.events.register("touchend",this,this.onClick,{extension:true});a.events.register("mousemove",this,this.onMousemove,{extension:true})},start:function(a){this.startEvt=a},cancel:function(a){delete this.startEvt},onClick:function(b){if(!this.startEvt||b.type!=="touchend"&&!OpenLayers.Event.isLeftClick(b)){return}var h=this.getFeatures(this.startEvt);delete this.startEvt;var g,f,e,d={};for(var c=0,a=h.length;c<a;++c){g=h[c];f=g.layer;d[f.id]=true;e=this.triggerEvent("featureclick",{feature:g});if(e===false){break}}for(c=0,a=this.map.layers.length;c<a;++c){f=this.map.layers[c];if(f instanceof OpenLayers.Layer.Vector&&!d[f.id]){this.triggerEvent("nofeatureclick",{layer:f})}}},onMousemove:function(j){delete this.startEvt;var c=this.getFeatures(j);var g={},b=[],k;for(var e=0,f=c.length;e<f;++e){k=c[e];g[k.id]=k;if(!this.cache[k.id]){b.push(k)}}var d=[];for(var a in this.cache){k=this.cache[a];if(k.layer&&k.layer.map){if(!g[k.id]){d.push(k)}}else{delete this.cache[a]}}var h;for(e=0,f=b.length;e<f;++e){k=b[e];this.cache[k.id]=k;h=this.triggerEvent("featureover",{feature:k});if(h===false){break}}for(e=0,f=d.length;e<f;++e){k=d[e];delete this.cache[k.id];h=this.triggerEvent("featureout",{feature:k});if(h===false){break}}},triggerEvent:function(d,a){var c=a.feature?a.feature.layer:a.layer,b=this.target.object;if(b instanceof OpenLayers.Map||b===c){return this.target.triggerEvent(d,a)}},getFeatures:function(k){var j=k.clientX,h=k.clientY,a=[],f=[],c=[],d,g,l,b,e;for(b=this.map.layers.length-1;b>=0;--b){d=this.map.layers[b];if(d.div.style.display!=="none"){if(d.renderer instanceof OpenLayers.Renderer.Elements){if(d instanceof OpenLayers.Layer.Vector){g=document.elementFromPoint(j,h);while(g&&g._featureId){l=d.getFeatureById(g._featureId);if(l){a.push(l);g.style.display="none";f.push(g);g=document.elementFromPoint(j,h)}else{g=false}}}c.push(d);d.div.style.display="none"}else{if(d.renderer instanceof OpenLayers.Renderer.Canvas){l=d.renderer.getFeatureIdFromEvent(k);if(l){a.push(l);c.push(d)}}}}}for(b=0,e=f.length;b<e;++b){f[b].style.display=""}for(b=c.length-1;b>=0;--b){c[b].div.style.display="block"}return a},destroy:function(){for(var a=this.provides.length-1;a>=0;--a){delete this.target.extensions[this.provides[a]]}this.map.events.un({mousemove:this.onMousemove,mousedown:this.start,mouseup:this.onClick,touchstart:this.start,touchmove:this.cancel,touchend:this.onClick,scope:this});delete this.cache;delete this.map;delete this.target}});OpenLayers.Events.nofeatureclick=OpenLayers.Events.featureclick;OpenLayers.Events.featureover=OpenLayers.Events.featureclick;OpenLayers.Events.featureout=OpenLayers.Events.featureclick;