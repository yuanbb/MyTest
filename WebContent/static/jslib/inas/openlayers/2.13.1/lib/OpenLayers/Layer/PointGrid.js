OpenLayers.Layer.PointGrid=OpenLayers.Class(OpenLayers.Layer.Vector,{dx:null,dy:null,ratio:1.5,maxFeatures:250,rotation:0,origin:null,gridBounds:null,initialize:function(a){a=a||{};OpenLayers.Layer.Vector.prototype.initialize.apply(this,[a.name,a])},setMap:function(a){OpenLayers.Layer.Vector.prototype.setMap.apply(this,arguments);a.events.register("moveend",this,this.onMoveEnd)},removeMap:function(a){a.events.unregister("moveend",this,this.onMoveEnd);OpenLayers.Layer.Vector.prototype.removeMap.apply(this,arguments)},setRatio:function(a){this.ratio=a;this.updateGrid(true)},setMaxFeatures:function(a){this.maxFeatures=a;this.updateGrid(true)},setSpacing:function(b,a){this.dx=b;this.dy=a||b;this.updateGrid(true)},setOrigin:function(a){this.origin=a;this.updateGrid(true)},getOrigin:function(){if(!this.origin){this.origin=this.map.getExtent().getCenterLonLat()}return this.origin},setRotation:function(a){this.rotation=a;this.updateGrid(true)},onMoveEnd:function(){this.updateGrid()},getViewBounds:function(){var d=this.map.getExtent();if(this.rotation){var a=this.getOrigin();var b=new OpenLayers.Geometry.Point(a.lon,a.lat);var c=d.toGeometry();c.rotate(-this.rotation,b);d=c.getBounds()}return d},updateGrid:function(c){if(c||this.invalidBounds()){var g=this.getViewBounds();var z=this.getOrigin();var r=new OpenLayers.Geometry.Point(z.lon,z.lat);var d=g.getWidth();var q=g.getHeight();var a=d/q;var o=Math.sqrt(this.dx*this.dy*this.maxFeatures/a);var u=o*a;var v=Math.min(d*this.ratio,u);var n=Math.min(q*this.ratio,o);var w=g.getCenterLonLat();this.gridBounds=new OpenLayers.Bounds(w.lon-(v/2),w.lat-(n/2),w.lon+(v/2),w.lat+(n/2));var l=Math.floor(n/this.dy);var m=Math.floor(v/this.dx);var b=z.lon+(this.dx*Math.ceil((this.gridBounds.left-z.lon)/this.dx));var e=z.lat+(this.dy*Math.ceil((this.gridBounds.bottom-z.lat)/this.dy));var f=new Array(l*m);var k,h,p;for(var t=0;t<m;++t){k=b+(t*this.dx);for(var s=0;s<l;++s){h=e+(s*this.dy);p=new OpenLayers.Geometry.Point(k,h);if(this.rotation){p.rotate(this.rotation,r)}f[(t*l)+s]=new OpenLayers.Feature.Vector(p)}}this.destroyFeatures(this.features,{silent:true});this.addFeatures(f,{silent:true})}},invalidBounds:function(){return !this.gridBounds||!this.gridBounds.containsBounds(this.getViewBounds())},CLASS_NAME:"OpenLayers.Layer.PointGrid"});