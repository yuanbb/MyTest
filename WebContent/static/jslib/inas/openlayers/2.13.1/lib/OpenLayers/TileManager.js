OpenLayers.TileManager=OpenLayers.Class({cacheSize:256,tilesPerFrame:2,frameDelay:16,moveDelay:100,zoomDelay:200,maps:null,tileQueueId:null,tileQueue:null,tileCache:null,tileCacheIndex:null,initialize:function(a){OpenLayers.Util.extend(this,a);this.maps=[];this.tileQueueId={};this.tileQueue={};this.tileCache={};this.tileCacheIndex=[]},addMap:function(c){if(this._destroyed||!OpenLayers.Layer.Grid){return}this.maps.push(c);this.tileQueue[c.id]=[];for(var a=0,b=c.layers.length;a<b;++a){this.addLayer({layer:c.layers[a]})}c.events.on({move:this.move,zoomend:this.zoomEnd,changelayer:this.changeLayer,addlayer:this.addLayer,preremovelayer:this.removeLayer,scope:this})},removeMap:function(c){if(this._destroyed||!OpenLayers.Layer.Grid){return}window.clearTimeout(this.tileQueueId[c.id]);if(c.layers){for(var a=0,b=c.layers.length;a<b;++a){this.removeLayer({layer:c.layers[a]})}}if(c.events){c.events.un({move:this.move,zoomend:this.zoomEnd,changelayer:this.changeLayer,addlayer:this.addLayer,preremovelayer:this.removeLayer,scope:this})}delete this.tileQueue[c.id];delete this.tileQueueId[c.id];OpenLayers.Util.removeItem(this.maps,c)},move:function(a){this.updateTimeout(a.object,this.moveDelay,true)},zoomEnd:function(a){this.updateTimeout(a.object,this.zoomDelay)},changeLayer:function(a){if(a.property==="visibility"||a.property==="params"){this.updateTimeout(a.object,0)}},addLayer:function(a){var d=a.layer;if(d instanceof OpenLayers.Layer.Grid){d.events.on({addtile:this.addTile,retile:this.clearTileQueue,scope:this});var c,b,e;for(c=d.grid.length-1;c>=0;--c){for(b=d.grid[c].length-1;b>=0;--b){e=d.grid[c][b];this.addTile({tile:e});if(e.url&&!e.imgDiv){this.manageTileCache({object:e})}}}}},removeLayer:function(a){var d=a.layer;if(d instanceof OpenLayers.Layer.Grid){this.clearTileQueue({object:d});if(d.events){d.events.un({addtile:this.addTile,retile:this.clearTileQueue,scope:this})}if(d.grid){var c,b,e;for(c=d.grid.length-1;c>=0;--c){for(b=d.grid[c].length-1;b>=0;--b){e=d.grid[c][b];this.unloadTile({object:e})}}}}},updateTimeout:function(d,a,c){window.clearTimeout(this.tileQueueId[d.id]);var b=this.tileQueue[d.id];if(!c||b.length){this.tileQueueId[d.id]=window.setTimeout(OpenLayers.Function.bind(function(){this.drawTilesFromQueue(d);if(b.length){this.updateTimeout(d,this.frameDelay)}},this),a)}},addTile:function(a){if(a.tile instanceof OpenLayers.Tile.Image){a.tile.events.on({beforedraw:this.queueTileDraw,beforeload:this.manageTileCache,loadend:this.addToCache,unload:this.unloadTile,scope:this})}else{this.removeLayer({layer:a.tile.layer})}},unloadTile:function(a){var b=a.object;b.events.un({beforedraw:this.queueTileDraw,beforeload:this.manageTileCache,loadend:this.addToCache,unload:this.unloadTile,scope:this});OpenLayers.Util.removeItem(this.tileQueue[b.layer.map.id],b)},queueTileDraw:function(a){var f=a.object;var g=false;var d=f.layer;var c=d.getURL(f.bounds);var b=this.tileCache[c];if(b&&b.className!=="olTileImage"){delete this.tileCache[c];OpenLayers.Util.removeItem(this.tileCacheIndex,c);b=null}if(d.url&&(d.async||!b)){var e=this.tileQueue[d.map.id];if(!~OpenLayers.Util.indexOf(e,f)){e.push(f)}g=true}return !g},drawTilesFromQueue:function(d){var c=this.tileQueue[d.id];var b=this.tilesPerFrame;var a=d.zoomTween&&d.zoomTween.playing;while(!a&&c.length&&b){c.shift().draw(true);--b}},manageTileCache:function(a){var c=a.object;var b=this.tileCache[c.url];if(b){if(b.parentNode&&OpenLayers.Element.hasClass(b.parentNode,"olBackBuffer")){b.parentNode.removeChild(b);b.id=null}if(!b.parentNode){b.style.visibility="hidden";b.style.opacity=0;c.setImage(b);OpenLayers.Util.removeItem(this.tileCacheIndex,c.url);this.tileCacheIndex.push(c.url)}}},addToCache:function(a){var b=a.object;if(!this.tileCache[b.url]){if(!OpenLayers.Element.hasClass(b.imgDiv,"olImageLoadError")){if(this.tileCacheIndex.length>=this.cacheSize){delete this.tileCache[this.tileCacheIndex[0]];this.tileCacheIndex.shift()}this.tileCache[b.url]=b.imgDiv;this.tileCacheIndex.push(b.url)}}},clearTileQueue:function(a){var c=a.object;var d=this.tileQueue[c.map.id];for(var b=d.length-1;b>=0;--b){if(d[b].layer===c){d.splice(b,1)}}},destroy:function(){for(var a=this.maps.length-1;a>=0;--a){this.removeMap(this.maps[a])}this.maps=null;this.tileQueue=null;this.tileQueueId=null;this.tileCache=null;this.tileCacheIndex=null;this._destroyed=true}});