OpenLayers.Layer.Bing=OpenLayers.Class(OpenLayers.Layer.XYZ,{key:null,serverResolutions:[156543.03390625,78271.516953125,39135.7584765625,19567.87923828125,9783.939619140625,4891.9698095703125,2445.9849047851562,1222.9924523925781,611.4962261962891,305.74811309814453,152.87405654907226,76.43702827453613,38.218514137268066,19.109257068634033,9.554628534317017,4.777314267158508,2.388657133579254,1.194328566789627,0.5971642833948135,0.29858214169740677,0.14929107084870338,0.07464553542435169],attributionTemplate:'<span class="olBingAttribution ${type}"><div><a target="_blank" href="http://www.bing.com/maps/"><img src="${logo}" /></a></div>${copyrights}<a style="white-space: nowrap" target="_blank" href="http://www.microsoft.com/maps/product/terms.html">Terms of Use</a></span>',metadata:null,protocolRegex:/^http:/i,type:"Road",culture:"en-US",metadataParams:null,tileOptions:null,protocol:~window.location.href.indexOf("http")?"":"http:",initialize:function(c){c=OpenLayers.Util.applyDefaults({sphericalMercator:true},c);var b=c.name||"Bing "+(c.type||this.type);var a=[b,null,c];OpenLayers.Layer.XYZ.prototype.initialize.apply(this,a);this.tileOptions=OpenLayers.Util.extend({crossOriginKeyword:"anonymous"},this.options.tileOptions);this.loadMetadata()},loadMetadata:function(){this._callbackId="_callback_"+this.id.replace(/\./g,"_");window[this._callbackId]=OpenLayers.Function.bind(OpenLayers.Layer.Bing.processMetadata,this);var c=OpenLayers.Util.applyDefaults({key:this.key,jsonp:this._callbackId,include:"ImageryProviders"},this.metadataParams);var b=this.protocol+"//dev.virtualearth.net/REST/v1/Imagery/Metadata/"+this.type+"?"+OpenLayers.Util.getParameterString(c);var a=document.createElement("script");a.type="text/javascript";a.src=b;a.id=this._callbackId;document.getElementsByTagName("head")[0].appendChild(a)},initLayer:function(){var c=this.metadata.resourceSets[0].resources[0];var a=c.imageUrl.replace("{quadkey}","${quadkey}");a=a.replace("{culture}",this.culture);a=a.replace(this.protocolRegex,this.protocol);this.url=[];for(var b=0;b<c.imageUrlSubdomains.length;++b){this.url.push(a.replace("{subdomain}",c.imageUrlSubdomains[b]))}this.addOptions({maxResolution:Math.min(this.serverResolutions[c.zoomMin],this.maxResolution||Number.POSITIVE_INFINITY),numZoomLevels:Math.min(c.zoomMax+1-c.zoomMin,this.numZoomLevels)},true);if(!this.isBaseLayer){this.redraw()}this.updateAttribution()},getURL:function(a){if(!this.url){return}var g=this.getXYZ(a),k=g.x,h=g.y,f=g.z;var c=[];for(var d=f;d>0;--d){var j="0";var l=1<<(d-1);if((k&l)!=0){j++}if((h&l)!=0){j++;j++}c.push(j)}var e=c.join("");var b=this.selectUrl(""+k+h+f,this.url);return OpenLayers.String.format(b,{quadkey:e})},updateAttribution:function(){var h=this.metadata;if(!h.resourceSets||!this.map||!this.map.center){return}var g=h.resourceSets[0].resources[0];var p=this.map.getExtent().transform(this.map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));var d=g.imageryProviders||[],o=OpenLayers.Util.indexOf(this.serverResolutions,this.getServerResolution()),b="",k,e,n,c,f,m,l;for(e=0,n=d.length;e<n;++e){k=d[e];for(c=0,f=k.coverageAreas.length;c<f;++c){l=k.coverageAreas[c];m=OpenLayers.Bounds.fromArray(l.bbox,true);if(p.intersectsBounds(m)&&o<=l.zoomMax&&o>=l.zoomMin){b+=k.attribution+" "}}}var a=h.brandLogoUri.replace(this.protocolRegex,this.protocol);this.attribution=OpenLayers.String.format(this.attributionTemplate,{type:this.type.toLowerCase(),logo:a,copyrights:b});this.map&&this.map.events.triggerEvent("changelayer",{layer:this,property:"attribution"})},setMap:function(){OpenLayers.Layer.XYZ.prototype.setMap.apply(this,arguments);this.map.events.register("moveend",this,this.updateAttribution)},clone:function(a){if(a==null){a=new OpenLayers.Layer.Bing(this.options)}a=OpenLayers.Layer.XYZ.prototype.clone.apply(this,[a]);return a},destroy:function(){this.map&&this.map.events.unregister("moveend",this,this.updateAttribution);OpenLayers.Layer.XYZ.prototype.destroy.apply(this,arguments)},CLASS_NAME:"OpenLayers.Layer.Bing"});OpenLayers.Layer.Bing.processMetadata=function(b){this.metadata=b;this.initLayer();var a=document.getElementById(this._callbackId);a.parentNode.removeChild(a);window[this._callbackId]=undefined;delete this._callbackId};