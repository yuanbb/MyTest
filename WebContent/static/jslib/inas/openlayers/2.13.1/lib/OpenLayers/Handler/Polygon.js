OpenLayers.Handler.Polygon=OpenLayers.Class(OpenLayers.Handler.Path,{holeModifier:null,drawingHole:false,polygon:null,createFeature:function(a){var b=this.layer.getLonLatFromViewPortPx(a);var c=new OpenLayers.Geometry.Point(b.lon,b.lat);this.point=new OpenLayers.Feature.Vector(c);this.line=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.LinearRing([this.point.geometry]));this.polygon=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Polygon([this.line.geometry]));this.callback("create",[this.point.geometry,this.getSketch()]);this.point.geometry.clearBounds();this.layer.addFeatures([this.polygon,this.point],{silent:true})},addPoint:function(a){if(!this.drawingHole&&this.holeModifier&&this.evt&&this.evt[this.holeModifier]){var f=this.point.geometry;var e=this.control.layer.features;var d,c;for(var b=e.length-1;b>=0;--b){d=e[b].geometry;if((d instanceof OpenLayers.Geometry.Polygon||d instanceof OpenLayers.Geometry.MultiPolygon)&&d.intersects(f)){c=e[b];this.control.layer.removeFeatures([c],{silent:true});this.control.layer.events.registerPriority("sketchcomplete",this,this.finalizeInteriorRing);this.control.layer.events.registerPriority("sketchmodified",this,this.enforceTopology);c.geometry.addComponent(this.line.geometry);this.polygon=c;this.drawingHole=true;break}}}OpenLayers.Handler.Path.prototype.addPoint.apply(this,arguments)},getCurrentPointIndex:function(){return this.line.geometry.components.length-2},enforceTopology:function(d){var a=d.vertex;var c=this.line.geometry.components;if(!this.polygon.geometry.intersects(a)){var b=c[c.length-3];a.x=b.x;a.y=b.y}},finishGeometry:function(){var a=this.line.geometry.components.length-2;this.line.geometry.removeComponent(this.line.geometry.components[a]);this.removePoint();this.finalize()},finalizeInteriorRing:function(){var c=this.line.geometry;var b=(c.getArea()!==0);if(b){var h=this.polygon.geometry.components;for(var d=h.length-2;d>=0;--d){if(c.intersects(h[d])){b=false;break}}if(b){var g;outer:for(var d=h.length-2;d>0;--d){var e=h[d].components;for(var a=0,f=e.length;a<f;++a){if(c.containsPoint(e[a])){b=false;break outer}}}}}if(b){if(this.polygon.state!==OpenLayers.State.INSERT){this.polygon.state=OpenLayers.State.UPDATE}}else{this.polygon.geometry.removeComponent(c)}this.restoreFeature();return false},cancel:function(){if(this.drawingHole){this.polygon.geometry.removeComponent(this.line.geometry);this.restoreFeature(true)}return OpenLayers.Handler.Path.prototype.cancel.apply(this,arguments)},restoreFeature:function(a){this.control.layer.events.unregister("sketchcomplete",this,this.finalizeInteriorRing);this.control.layer.events.unregister("sketchmodified",this,this.enforceTopology);this.layer.removeFeatures([this.polygon],{silent:true});this.control.layer.addFeatures([this.polygon],{silent:true});this.drawingHole=false;if(!a){this.control.layer.events.triggerEvent("sketchcomplete",{feature:this.polygon})}},destroyFeature:function(a){OpenLayers.Handler.Path.prototype.destroyFeature.call(this,a);this.polygon=null},drawFeature:function(){this.layer.drawFeature(this.polygon,this.style);this.layer.drawFeature(this.point,this.style)},getSketch:function(){return this.polygon},getGeometry:function(){var a=this.polygon&&this.polygon.geometry;if(a&&this.multi){a=new OpenLayers.Geometry.MultiPolygon([a])}return a},CLASS_NAME:"OpenLayers.Handler.Polygon"});