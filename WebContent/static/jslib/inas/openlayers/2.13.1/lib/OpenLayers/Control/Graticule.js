OpenLayers.Control.Graticule=OpenLayers.Class(OpenLayers.Control,{autoActivate:true,intervals:[45,30,20,10,5,2,1,0.5,0.2,0.1,0.05,0.01,0.005,0.002,0.001],displayInLayerSwitcher:true,visible:true,numPoints:50,targetSize:200,layerName:null,labelled:true,labelFormat:"dm",lineSymbolizer:{strokeColor:"#333",strokeWidth:1,strokeOpacity:0.5},labelSymbolizer:{},gratLayer:null,initialize:function(a){a=a||{};a.layerName=a.layerName||OpenLayers.i18n("Graticule");OpenLayers.Control.prototype.initialize.apply(this,[a]);this.labelSymbolizer.stroke=false;this.labelSymbolizer.fill=false;this.labelSymbolizer.label="${label}";this.labelSymbolizer.labelAlign="${labelAlign}";this.labelSymbolizer.labelXOffset="${xOffset}";this.labelSymbolizer.labelYOffset="${yOffset}"},destroy:function(){this.deactivate();OpenLayers.Control.prototype.destroy.apply(this,arguments);if(this.gratLayer){this.gratLayer.destroy();this.gratLayer=null}},draw:function(){OpenLayers.Control.prototype.draw.apply(this,arguments);if(!this.gratLayer){var a=new OpenLayers.Style({},{rules:[new OpenLayers.Rule({symbolizer:{Point:this.labelSymbolizer,Line:this.lineSymbolizer}})]});this.gratLayer=new OpenLayers.Layer.Vector(this.layerName,{styleMap:new OpenLayers.StyleMap({"default":a}),visibility:this.visible,displayInLayerSwitcher:this.displayInLayerSwitcher})}return this.div},activate:function(){if(OpenLayers.Control.prototype.activate.apply(this,arguments)){this.map.addLayer(this.gratLayer);this.map.events.register("moveend",this,this.update);this.update();return true}else{return false}},deactivate:function(){if(OpenLayers.Control.prototype.deactivate.apply(this,arguments)){this.map.events.unregister("moveend",this,this.update);this.map.removeLayer(this.gratLayer);return true}else{return false}},update:function(){var k=this.map.getExtent();if(!k){return}this.gratLayer.destroyFeatures();var l=new OpenLayers.Projection("EPSG:4326");var G=this.map.getProjectionObject();var g=this.map.getResolution();if(G.proj&&G.proj.projName=="longlat"){this.numPoints=1}var J=this.map.getCenter();var C=new OpenLayers.Pixel(J.lon,J.lat);OpenLayers.Projection.transform(C,G,l);var x=this.targetSize*g;x*=x;var p;for(var B=0;B<this.intervals.length;++B){p=this.intervals[B];var H=p/2;var d=C.offset({x:-H,y:-H});var b=C.offset({x:H,y:H});OpenLayers.Projection.transform(d,l,G);OpenLayers.Projection.transform(b,l,G);var e=(d.x-b.x)*(d.x-b.x)+(d.y-b.y)*(d.y-b.y);if(e<=x){break}}C.x=Math.floor(C.x/p)*p;C.y=Math.floor(C.y/p)*p;var A=0;var q=[C.clone()];var o=C.clone();var y;do{o=o.offset({x:0,y:p});y=OpenLayers.Projection.transform(o.clone(),l,G);q.unshift(o)}while(k.containsPixel(y)&&++A<1000);o=C.clone();do{o=o.offset({x:0,y:-p});y=OpenLayers.Projection.transform(o.clone(),l,G);q.push(o)}while(k.containsPixel(y)&&++A<1000);A=0;var v=[C.clone()];o=C.clone();do{o=o.offset({x:-p,y:0});y=OpenLayers.Projection.transform(o.clone(),l,G);v.unshift(o)}while(k.containsPixel(y)&&++A<1000);o=C.clone();do{o=o.offset({x:p,y:0});y=OpenLayers.Projection.transform(o.clone(),l,G);v.push(o)}while(k.containsPixel(y)&&++A<1000);var a=[];for(var B=0;B<v.length;++B){var f=v[B].x;var u=[];var I=null;var D=Math.min(q[0].y,90);var n=Math.max(q[q.length-1].y,-90);var c=(D-n)/this.numPoints;var h=n;for(var z=0;z<=this.numPoints;++z){var E=new OpenLayers.Geometry.Point(f,h);E.transform(l,G);u.push(E);h+=c;if(E.y>=k.bottom&&!I){I=E}}if(this.labelled){var s=new OpenLayers.Geometry.Point(I.x,k.bottom);var F={value:f,label:this.labelled?OpenLayers.Util.getFormattedLonLat(f,"lon",this.labelFormat):"",labelAlign:"cb",xOffset:0,yOffset:2};this.gratLayer.addFeatures(new OpenLayers.Feature.Vector(s,F))}var t=new OpenLayers.Geometry.LineString(u);a.push(new OpenLayers.Feature.Vector(t))}for(var z=0;z<q.length;++z){h=q[z].y;if(h<-90||h>90){continue}var u=[];var w=v[0].x;var r=v[v.length-1].x;var m=(r-w)/this.numPoints;var f=w;var I=null;for(var B=0;B<=this.numPoints;++B){var E=new OpenLayers.Geometry.Point(f,h);E.transform(l,G);u.push(E);f+=m;if(E.x<k.right){I=E}}if(this.labelled){var s=new OpenLayers.Geometry.Point(k.right,I.y);var F={value:h,label:this.labelled?OpenLayers.Util.getFormattedLonLat(h,"lat",this.labelFormat):"",labelAlign:"rb",xOffset:-2,yOffset:2};this.gratLayer.addFeatures(new OpenLayers.Feature.Vector(s,F))}var t=new OpenLayers.Geometry.LineString(u);a.push(new OpenLayers.Feature.Vector(t))}this.gratLayer.addFeatures(a)},CLASS_NAME:"OpenLayers.Control.Graticule"});