OpenLayers.Renderer.Canvas=OpenLayers.Class(OpenLayers.Renderer,{hitDetection:true,hitOverflow:0,canvas:null,features:null,pendingRedraw:false,cachedSymbolBounds:{},initialize:function(a,b){OpenLayers.Renderer.prototype.initialize.apply(this,arguments);this.root=document.createElement("canvas");this.container.appendChild(this.root);this.canvas=this.root.getContext("2d");this.features={};if(this.hitDetection){this.hitCanvas=document.createElement("canvas");this.hitContext=this.hitCanvas.getContext("2d")}},setExtent:function(){OpenLayers.Renderer.prototype.setExtent.apply(this,arguments);return false},eraseGeometry:function(b,a){this.eraseFeatures(this.features[a][0])},supported:function(){return OpenLayers.CANVAS_SUPPORTED},setSize:function(b){this.size=b.clone();var a=this.root;a.style.width=b.w+"px";a.style.height=b.h+"px";a.width=b.w;a.height=b.h;this.resolution=null;if(this.hitDetection){var c=this.hitCanvas;c.style.width=b.w+"px";c.style.height=b.h+"px";c.width=b.w;c.height=b.h}},drawFeature:function(a,b){var f;if(a.geometry){b=this.applyDefaultSymbolizer(b||a.style);var e=a.geometry.getBounds();var d;if(this.map.baseLayer&&this.map.baseLayer.wrapDateLine){d=this.map.getMaxExtent()}var c=e&&e.intersectsBounds(this.extent,{worldBounds:d});f=(b.display!=="none")&&!!e&&c;if(f){this.features[a.id]=[a,b]}else{delete (this.features[a.id])}this.pendingRedraw=true}if(this.pendingRedraw&&!this.locked){this.redraw();this.pendingRedraw=false}return f},drawGeometry:function(e,c,d){var b=e.CLASS_NAME;if((b=="OpenLayers.Geometry.Collection")||(b=="OpenLayers.Geometry.MultiPoint")||(b=="OpenLayers.Geometry.MultiLineString")||(b=="OpenLayers.Geometry.MultiPolygon")){for(var a=0;a<e.components.length;a++){this.drawGeometry(e.components[a],c,d)}return}switch(e.CLASS_NAME){case"OpenLayers.Geometry.Point":this.drawPoint(e,c,d);break;case"OpenLayers.Geometry.LineString":this.drawLineString(e,c,d);break;case"OpenLayers.Geometry.LinearRing":this.drawLinearRing(e,c,d);break;case"OpenLayers.Geometry.Polygon":this.drawPolygon(e,c,d);break;default:break}},drawExternalGraphic:function(i,a,d){var e=new Image();var j=a.title||a.graphicTitle;if(j){e.title=j}var b=a.graphicWidth||a.graphicHeight;var k=a.graphicHeight||a.graphicWidth;b=b?b:a.pointRadius*2;k=k?k:a.pointRadius*2;var g=(a.graphicXOffset!=undefined)?a.graphicXOffset:-(0.5*b);var c=(a.graphicYOffset!=undefined)?a.graphicYOffset:-(0.5*k);var f=a.graphicOpacity||a.fillOpacity;var h=function(){if(!this.features[d]){return}var o=this.getLocalXY(i);var r=o[0];var p=o[1];if(!isNaN(r)&&!isNaN(p)){var l=(r+g)|0;var q=(p+c)|0;var m=this.canvas;m.globalAlpha=f;var n=OpenLayers.Renderer.Canvas.drawImageScaleFactor||(OpenLayers.Renderer.Canvas.drawImageScaleFactor=/android 2.1/.test(navigator.userAgent.toLowerCase())?320/window.screen.width:1);m.drawImage(e,l*n,q*n,b*n,k*n);if(this.hitDetection){this.setHitContextStyle("fill",d);this.hitContext.fillRect(l,q,b,k)}}};e.onload=OpenLayers.Function.bind(h,this);e.src=a.externalGraphic},drawNamedSymbol:function(m,b,h){var n,l,g,f,j,a,c,e;var k;var o=Math.PI/180;var d=OpenLayers.Renderer.symbol[b.graphicName];if(!d){throw new Error(b.graphicName+" is not a valid symbol name")}if(!d.length||d.length<2){return}var r=this.getLocalXY(m);var q=r[0];var p=r[1];if(isNaN(q)||isNaN(p)){return}this.canvas.lineCap="round";this.canvas.lineJoin="round";if(this.hitDetection){this.hitContext.lineCap="round";this.hitContext.lineJoin="round"}if(b.graphicName in this.cachedSymbolBounds){a=this.cachedSymbolBounds[b.graphicName]}else{a=new OpenLayers.Bounds();for(j=0;j<d.length;j+=2){a.extend(new OpenLayers.LonLat(d[j],d[j+1]))}this.cachedSymbolBounds[b.graphicName]=a}this.canvas.save();if(this.hitDetection){this.hitContext.save()}this.canvas.translate(q,p);if(this.hitDetection){this.hitContext.translate(q,p)}e=o*b.rotation;if(!isNaN(e)){this.canvas.rotate(e);if(this.hitDetection){this.hitContext.rotate(e)}}c=2*b.pointRadius/Math.max(a.getWidth(),a.getHeight());this.canvas.scale(c,c);if(this.hitDetection){this.hitContext.scale(c,c)}g=a.getCenterLonLat().lon;f=a.getCenterLonLat().lat;this.canvas.translate(-g,-f);if(this.hitDetection){this.hitContext.translate(-g,-f)}k=b.strokeWidth;b.strokeWidth=k/c;if(b.fill!==false){this.setCanvasStyle("fill",b);this.canvas.beginPath();for(j=0;j<d.length;j=j+2){n=d[j];l=d[j+1];if(j==0){this.canvas.moveTo(n,l)}this.canvas.lineTo(n,l)}this.canvas.closePath();this.canvas.fill();if(this.hitDetection){this.setHitContextStyle("fill",h,b);this.hitContext.beginPath();for(j=0;j<d.length;j=j+2){n=d[j];l=d[j+1];if(j==0){this.canvas.moveTo(n,l)}this.hitContext.lineTo(n,l)}this.hitContext.closePath();this.hitContext.fill()}}if(b.stroke!==false){this.setCanvasStyle("stroke",b);this.canvas.beginPath();for(j=0;j<d.length;j=j+2){n=d[j];l=d[j+1];if(j==0){this.canvas.moveTo(n,l)}this.canvas.lineTo(n,l)}this.canvas.closePath();this.canvas.stroke();if(this.hitDetection){this.setHitContextStyle("stroke",h,b,c);this.hitContext.beginPath();for(j=0;j<d.length;j=j+2){n=d[j];l=d[j+1];if(j==0){this.hitContext.moveTo(n,l)}this.hitContext.lineTo(n,l)}this.hitContext.closePath();this.hitContext.stroke()}}b.strokeWidth=k;this.canvas.restore();if(this.hitDetection){this.hitContext.restore()}this.setCanvasStyle("reset")},setCanvasStyle:function(b,a){if(b==="fill"){this.canvas.globalAlpha=a.fillOpacity;this.canvas.fillStyle=a.fillColor}else{if(b==="stroke"){this.canvas.globalAlpha=a.strokeOpacity;this.canvas.strokeStyle=a.strokeColor;this.canvas.lineWidth=a.strokeWidth}else{this.canvas.globalAlpha=0;this.canvas.lineWidth=1}}},featureIdToHex:function(c){var d=Number(c.split("_").pop())+1;if(d>=16777216){this.hitOverflow=d-16777215;d=d%16777216+1}var b="000000"+d.toString(16);var a=b.length;b="#"+b.substring(a-6,a);return b},setHitContextStyle:function(b,e,a,d){var c=this.featureIdToHex(e);if(b=="fill"){this.hitContext.globalAlpha=1;this.hitContext.fillStyle=c}else{if(b=="stroke"){this.hitContext.globalAlpha=1;this.hitContext.strokeStyle=c;if(typeof d==="undefined"){this.hitContext.lineWidth=a.strokeWidth+2}else{if(!isNaN(d)){this.hitContext.lineWidth=a.strokeWidth+2/d}}}else{this.hitContext.globalAlpha=0;this.hitContext.lineWidth=1}}},drawPoint:function(g,c,f){if(c.graphic!==false){if(c.externalGraphic){this.drawExternalGraphic(g,c,f)}else{if(c.graphicName&&(c.graphicName!="circle")){this.drawNamedSymbol(g,c,f)}else{var d=this.getLocalXY(g);var h=d[0];var e=d[1];if(!isNaN(h)&&!isNaN(e)){var b=Math.PI*2;var a=c.pointRadius;if(c.fill!==false){this.setCanvasStyle("fill",c);this.canvas.beginPath();this.canvas.arc(h,e,a,0,b,true);this.canvas.fill();if(this.hitDetection){this.setHitContextStyle("fill",f,c);this.hitContext.beginPath();this.hitContext.arc(h,e,a,0,b,true);this.hitContext.fill()}}if(c.stroke!==false){this.setCanvasStyle("stroke",c);this.canvas.beginPath();this.canvas.arc(h,e,a,0,b,true);this.canvas.stroke();if(this.hitDetection){this.setHitContextStyle("stroke",f,c);this.hitContext.beginPath();this.hitContext.arc(h,e,a,0,b,true);this.hitContext.stroke()}this.setCanvasStyle("reset")}}}}}},drawLineString:function(c,a,b){a=OpenLayers.Util.applyDefaults({fill:false},a);this.drawLinearRing(c,a,b)},drawLinearRing:function(c,a,b){if(a.fill!==false){this.setCanvasStyle("fill",a);this.renderPath(this.canvas,c,a,b,"fill");if(this.hitDetection){this.setHitContextStyle("fill",b,a);this.renderPath(this.hitContext,c,a,b,"fill")}}if(a.stroke!==false){this.setCanvasStyle("stroke",a);this.renderPath(this.canvas,c,a,b,"stroke");if(this.hitDetection){this.setHitContextStyle("stroke",b,a);this.renderPath(this.hitContext,c,a,b,"stroke")}}this.setCanvasStyle("reset")},renderPath:function(c,k,a,e,h){var f=k.components;var g=f.length;c.beginPath();var b=this.getLocalXY(f[0]);var l=b[0];var j=b[1];if(!isNaN(l)&&!isNaN(j)){c.moveTo(b[0],b[1]);for(var d=1;d<g;++d){var m=this.getLocalXY(f[d]);c.lineTo(m[0],m[1])}if(h==="fill"){c.fill()}else{c.stroke()}}},drawPolygon:function(f,c,e){var d=f.components;var a=d.length;this.drawLinearRing(d[0],c,e);for(var b=1;b<a;++b){this.canvas.globalCompositeOperation="destination-out";if(this.hitDetection){this.hitContext.globalCompositeOperation="destination-out"}this.drawLinearRing(d[b],OpenLayers.Util.applyDefaults({stroke:false,fillOpacity:1},c),e);this.canvas.globalCompositeOperation="source-over";if(this.hitDetection){this.hitContext.globalCompositeOperation="source-over"}this.drawLinearRing(d[b],OpenLayers.Util.applyDefaults({fill:false},c),e)}},drawText:function(l,a){var m=this.getLocalXY(l);this.setCanvasStyle("reset");this.canvas.fillStyle=a.fontColor;this.canvas.globalAlpha=a.fontOpacity||1;var d=[a.fontStyle?a.fontStyle:"normal","normal",a.fontWeight?a.fontWeight:"normal",a.fontSize?a.fontSize:"1em",a.fontFamily?a.fontFamily:"sans-serif"].join(" ");var c=a.label.split("\n");var f=c.length;if(this.canvas.fillText){this.canvas.font=d;this.canvas.textAlign=OpenLayers.Renderer.Canvas.LABEL_ALIGN[a.labelAlign[0]]||"center";this.canvas.textBaseline=OpenLayers.Renderer.Canvas.LABEL_ALIGN[a.labelAlign[1]]||"middle";var j=OpenLayers.Renderer.Canvas.LABEL_FACTOR[a.labelAlign[1]];if(j==null){j=-0.5}var k=this.canvas.measureText("Mg").height||this.canvas.measureText("xx").width;m[1]+=k*j*(f-1);for(var e=0;e<f;e++){if(a.labelOutlineWidth){this.canvas.save();this.canvas.globalAlpha=a.labelOutlineOpacity||a.fontOpacity||1;this.canvas.strokeStyle=a.labelOutlineColor;this.canvas.lineWidth=a.labelOutlineWidth;this.canvas.strokeText(c[e],m[0],m[1]+(k*e)+1);this.canvas.restore()}this.canvas.fillText(c[e],m[0],m[1]+(k*e))}}else{if(this.canvas.mozDrawText){this.canvas.mozTextStyle=d;var b=OpenLayers.Renderer.Canvas.LABEL_FACTOR[a.labelAlign[0]];if(b==null){b=-0.5}var j=OpenLayers.Renderer.Canvas.LABEL_FACTOR[a.labelAlign[1]];if(j==null){j=-0.5}var k=this.canvas.mozMeasureText("xx");m[1]+=k*(1+(j*f));for(var e=0;e<f;e++){var h=m[0]+(b*this.canvas.mozMeasureText(c[e]));var g=m[1]+(e*k);this.canvas.translate(h,g);this.canvas.mozDrawText(c[e]);this.canvas.translate(-h,-g)}}}this.setCanvasStyle("reset")},getLocalXY:function(b){var c=this.getResolution();var d=this.extent;var a=((b.x-this.featureDx)/c+(-d.left/c));var e=((d.top/c)-b.y/c);return[a,e]},clear:function(){var a=this.root.height;var b=this.root.width;this.canvas.clearRect(0,0,b,a);this.features={};if(this.hitDetection){this.hitContext.clearRect(0,0,b,a)}},getFeatureIdFromEvent:function(g){var c,i;if(this.hitDetection&&this.root.style.display!=="none"){if(!this.map.dragging){var h=g.xy;var f=h.x|0;var e=h.y|0;var d=this.hitContext.getImageData(f,e,1,1).data;if(d[3]===255){var a=d[2]+(256*(d[1]+(256*d[0])));if(a){c="OpenLayers_Feature_Vector_"+(a-1+this.hitOverflow);try{i=this.features[c][0]}catch(b){}}}}}return i},eraseFeatures:function(b){if(!(OpenLayers.Util.isArray(b))){b=[b]}for(var a=0;a<b.length;++a){delete this.features[b[a].id]}this.redraw()},redraw:function(){if(!this.locked){var j=this.root.height;var c=this.root.width;this.canvas.clearRect(0,0,c,j);if(this.hitDetection){this.hitContext.clearRect(0,0,c,j)}var f=[];var l,g,a;var h=(this.map.baseLayer&&this.map.baseLayer.wrapDateLine)&&this.map.getMaxExtent();for(var b in this.features){if(!this.features.hasOwnProperty(b)){continue}l=this.features[b][0];g=l.geometry;this.calculateFeatureDx(g.getBounds(),h);a=this.features[b][1];this.drawGeometry(g,a,l.id);if(a.label){f.push([l,a])}}var k;for(var d=0,e=f.length;d<e;++d){k=f[d];this.drawText(k[0].geometry.getCentroid(),k[1])}}},CLASS_NAME:"OpenLayers.Renderer.Canvas"});OpenLayers.Renderer.Canvas.LABEL_ALIGN={l:"left",r:"right",t:"top",b:"bottom"};OpenLayers.Renderer.Canvas.LABEL_FACTOR={l:0,r:-1,t:0,b:-1};OpenLayers.Renderer.Canvas.drawImageScaleFactor=null;